# 长治文旅大生态服务平台产品需求说明书

## 文档版本记录

| 版本号   | 修订日期       | 修订人      | 修订内容                                 | 审核人     |
| -------- | -------------- | ----------- | ---------------------------------------- | ---------- |
| v1.0     | 2025-12-09     | 产品团队    | 初始版本创建                             | 技术负责人 |
| v1.1     | 2025-12-10     | AI 助手     | 补充架构设计、数据模型、业务流程等       | -          |
| **v1.2** | **2025-12-10** | **AI 助手** | **重构技术架构方案，采用务实渐进式架构** | **待评审** |
|          |                |             | **主要变更：**                           |            |
|          |                |             | 1. 调整技术架构为四服务精简模型          |            |
|          |                |             | 2. 优化技术栈选型，降低复杂度            |            |
|          |                |             | 3. 采用渐进式架构演进策略                |            |
|          |                |             | 4. 明确三阶段实施路径                    |            |

## 术语表

| 术语      | 英文                              | 定义                                         |
| --------- | --------------------------------- | -------------------------------------------- |
| 用户端    | User Client                       | 面向游客的小程序应用                         |
| 商户端    | Merchant Client                   | 面向商户的小程序应用                         |
| PC 管理端 | PC Management                     | 面向平台管理员的 Web 管理系统                |
| SLA       | Service Level Agreement           | 服务级别协议                                 |
| API       | Application Programming Interface | 应用程序编程接口                             |
| SDK       | Software Development Kit          | 软件开发工具包                               |
| UGC       | User Generated Content            | 用户生成内容                                 |
| RFM 模型  | Recency Frequency Monetary        | 用户价值分析模型                             |
| QPS       | Queries Per Second                | 每秒查询率                                   |
| RPO       | Recovery Point Objective          | 恢复点目标                                   |
| RTO       | Recovery Time Objective           | 恢复时间目标                                 |
| CDN       | Content Delivery Network          | 内容分发网络                                 |
| WAF       | Web Application Firewall          | Web 应用防火墙                               |
| CCT Hub   | ChangZhi Culture & Tourism Hub    | 长治文旅生态中心（项目英文名）               |
| O2O       | Online to Offline                 | 线上到线下业务模式                           |
| UGC       | User Generated Content            | 用户生成内容                                 |
| RFM 模型  | Recency Frequency Monetary        | 最近一次消费、消费频率、消费金额用户分群模型 |
| ROI       | Return on Investment              | 投资回报率                                   |
| GMV       | Gross Merchandise Volume          | 商品交易总额                                 |
| DAU       | Daily Active Users                | 日活跃用户数                                 |
| MAU       | Monthly Active Users              | 月活跃用户数                                 |
| ARPU      | Average Revenue Per User          | 每用户平均收入                               |
| LTV       | Lifetime Value                    | 用户生命周期价值                             |
| CAC       | Customer Acquisition Cost         | 用户获取成本                                 |
| CTR       | Click-Through Rate                | 点击率                                       |
| CVR       | Conversion Rate                   | 转化率                                       |
| B 端      | Business                          | 企业/商户端                                  |
| C 端      | Consumer                          | 消费者/用户端                                |
| SaaS      | Software as a Service             | 软件即服务                                   |
| PaaS      | Platform as a Service             | 平台即服务                                   |
| IaaS      | Infrastructure as a Service       | 基础设施即服务                               |

---

## 1. 项目概述

### 1.1 项目背景

近年来，文旅产业数字化转型加速推进，各地方文旅部门需要探寻一条解决文旅 IP 打造、文旅流量获取和变现以及文旅收入大幅增长和数据入统的解决方案。

长治市作为山西省重要的文化旅游城市，拥有丰富的自然景观和人文资源，包括太行山大峡谷、八路军太行纪念馆、黄崖洞等知名景区。然而，当前文旅产业存在以下痛点：

1. **资源分散**：景区、餐饮、住宿、文创等资源分散，缺乏统一平台整合
2. **数字化程度低**：传统票务系统落后，游客体验不佳
3. **数据孤岛**：各景区数据不互通，难以进行全局分析和决策
4. **营销手段单一**：缺乏创新的营销活动和用户互动方式
5. **二次消费转化率低**：游客除门票外其他消费转化不足

本项目旨在打造长治市统一的文旅大生态服务平台，通过数字化手段整合文旅资源，提升游客体验，增加文旅收入，实现数据统一管理和分析。

### 1.2 项目目标

#### 1.2.1 业务目标

1. **资源整合**：整合全市景区、餐饮、住宿、文创、交通等文旅资源
2. **体验提升**：提供一站式文旅服务，提升游客游玩体验
3. **收入增长**：通过平台带动文旅产业链各环节收入增长
4. **数据入统**：实现文旅数据统一采集、分析和应用
5. **品牌打造**：塑造"长治文旅"统一品牌形象

#### 1.2.2 技术目标

1. **系统稳定性**：保证系统 99.95%以上的可用性
2. **性能要求**：支持日活用户 10 万+，峰值并发 5000+
3. **扩展性**：系统架构支持业务快速扩展
4. **安全性**：符合等保三级安全要求
5. **可维护性**：系统易于维护和升级

### 1.3 项目范围

本项目研发范围包括以下几个终端的功能开发、系统集成、数据对接及测试上线，具体如下：

- **用户端小程序**：涵盖首页、票务模块、餐饮模块、文创模块、活动模块、供需模块、个人中心及通用功能。
- **商户端小程序**：涵盖登录注册、商品管理、活动管理、核销管理、商户管理功能。
- **PC 管理端**：支持主流浏览器（Chrome、Firefox、Edge），涵盖商户管理、设备管理、用户管理、商品管理、订单管理、活动管理、财务管理、系统管理、供需管理、接口管理功能。
- **系统集成**：对接支付渠道、人脸识别、闸机设备接口、手持终端、短信服务等第三方服务。

### 1.4 项目约束

#### 1.4.1 时间约束

- 总工期：12 个月
- 第一阶段上线：3 个月内
- 全功能上线：9 个月内

#### 1.4.2 预算约束

- 总预算：待定
- 分阶段投入：第一阶段预算占总预算 30%

#### 1.4.3 技术约束

- 必须支持国产化操作系统和数据库
- 必须符合等保三级安全要求
- 必须支持与现有景区系统对接

#### 1.4.4 人员约束

- 核心团队规模：10-15 人
- 技术栈要求：团队现有技术能力匹配

### 1.5 项目成功标准

#### 1.5.1 业务成功标准

1. **用户指标**：注册用户数达到 50 万，月活用户达到 10 万
2. **交易指标**：年交易额突破 1 亿元，订单数达到 100 万单
3. **商户指标**：入驻商户达到 500 家，活跃商户 300 家
4. **体验指标**：用户满意度评分 4.5 分以上（5 分制）
5. **运营指标**：用户留存率 30%以上，复购率 40%以上

#### 1.5.2 技术成功标准

1. **性能指标**：系统可用性 99.95%，平均响应时间<200ms
2. **安全指标**：通过等保三级测评，无重大安全漏洞
3. **扩展指标**：支持业务量 3 倍增长无需架构重构
4. **成本指标**：基础设施成本控制在预算范围内

---

## 2. 功能概述和设计

### 2.1 功能导图

```mermaid
graph TD
    A[长治文旅平台] --> B[用户端]
    A --> C[商户端]
    A --> D[PC管理端]

    B --> B1[首页]
    B --> B2[票务模块]
    B --> B3[活动模块]
    B --> B4[消费模块]
    B --> B5[个人中心]

    B1 --> B11[轮播图]
    B1 --> B12[金刚区]
    B1 --> B13[景区推荐]
    B1 --> B14[活动推荐]
    B1 --> B15[公告通知]

    B2 --> B21[景区列表]
    B2 --> B22[票务详情]
    B2 --> B23[预约购买]
    B2 --> B24[购票凭证]
    B2 --> B25[退改签]

    B3 --> B31[活动清单]
    B3 --> B32[活动详情]
    B3 --> B33[打卡活动]
    B3 --> B34[积分活动]
    B3 --> B35[活动报名]

    B4 --> B41[扫码消费]
    B4 --> B42[商户导航]
    B4 --> B43[商品浏览]
    B4 --> B44[消费积分]

    B5 --> B51[会员信息]
    B5 --> B52[订单管理]
    B5 --> B53[钱包管理]
    B5 --> B54[积分管理]
    B5 --> B55[收货地址]
    B5 --> B56[消息通知]
    B5 --> B57[评价反馈]
    B5 --> B58[安全设置]
    B5 --> B59[供需管理]

    C --> C1[登录注册]
    C --> C2[商品管理]
    C --> C3[活动管理]
    C --> C4[核销管理]
    C --> C5[商户管理]

    C1 --> C11[授权登录]
    C1 --> C12[密码找回]
    C1 --> C13[入驻申请]

    C2 --> C21[商品列表]
    C2 --> C22[商品编辑]
    C2 --> C23[商品上下架]
    C2 --> C24[库存管理]
    C2 --> C25[商品分类]
    C2 --> C26[商品评价]

    C3 --> C31[活动列表]
    C3 --> C32[活动创建]
    C3 --> C33[活动编辑]
    C3 --> C34[活动详情]
    C3 --> C35[扫码验证]

    C4 --> C41[扫码核销]
    C4 --> C42[核销记录]
    C4 --> C43[批量核销]
    C4 --> C44[核销异常处理]

    C5 --> C51[商户信息]
    C5 --> C52[员工管理]
    C5 --> C53[经营统计]
    C5 --> C54[订单管理]
    C5 --> C55[钱包管理]
    C5 --> C56[投诉处理]
    C5 --> C57[常见问题]
    C5 --> C58[退出登录]

    D --> D1[商户管理]
    D --> D2[设备管理]
    D --> D3[用户管理]
    D --> D4[商品管理]
    D --> D5[订单管理]
    D --> D6[活动管理]
    D --> D7[财务管理]
    D --> D8[系统管理]
    D --> D9[供需管理]
    D --> D10[接口管理]

    D1 --> D11[商户列表]
    D1 --> D12[入驻审核]
    D1 --> D13[商户运营]
    D1 --> D14[商户信息管理]
    D1 --> D15[员工管理]

    D2 --> D21[设备列表]
    D2 --> D22[设备配置]
    D2 --> D23[运维管理]
    D2 --> D24[设备统计]

    D3 --> D31[用户列表]
    D3 --> D32[用户详情]
    D3 --> D33[用户行为分析]
    D3 --> D34[异常用户处理]

    D4 --> D41[分类管理]
    D4 --> D42[票种管理]
    D4 --> D43[商品审核]
    D4 --> D44[商品监控]
    D4 --> D45[积分赋值]
    D4 --> D46[商户商品管理]

    D5 --> D51[订单列表]
    D5 --> D52[订单详情]
    D5 --> D53[异常订单处理]
    D5 --> D54[订单统计]

    D6 --> D61[活动列表]
    D6 --> D62[活动审核]
    D6 --> D63[规则管理]
    D6 --> D64[打卡管理]
    D6 --> D65[活动数据统计]

    D7 --> D71[分账管理]
    D7 --> D72[流水管理]
    D7 --> D73[结算管理]
    D7 --> D74[发票管理]
    D7 --> D75[财务报表]

    D8 --> D81[权限管理]
    D8 --> D82[角色管理]
    D8 --> D83[日志管理]
    D8 --> D84[数据字典管理]
    D8 --> D85[备份恢复]

    D9 --> D91[供需发布]
    D9 --> D92[供需管理]
    D9 --> D93[报名记录]

    D10 --> D101[支付接口]
    D10 --> D102[设备接口]
    D10 --> D103[人脸接口]
    D10 --> D104[接口文档]
```

### 2.2 功能列表（表 T-2.2）

#### 2.2.1 用户端功能列表

| 终端   | 模块     | 功能                 | 编号           | 分期 | 描述                                                                                 |
| ------ | -------- | -------------------- | -------------- | ---- | ------------------------------------------------------------------------------------ |
| 用户端 | 首页     | 轮播图               | U-HOME-001     | 一期 | 支持跳转景区/活动/商品详情                                                           |
| 用户端 | 首页     | 金刚区               | U-HOME-002     | 一期 | 包含景区、餐饮、生鲜、文创、活动、会员中心入口                                       |
| 用户端 | 首页     | 个性化推荐           | U-HOME-003     | 二期 | 基于定位/历史订单推荐景区/商品/活动                                                  |
| 用户端 | 首页     | 最热活动             | U-HOME-004     | 一期 | 展示活动热度、剩余名额、参与方式                                                     |
| 用户端 | 首页     | 景区票务             | U-HOME-005     | 一期 | 展示单票、联票、套票，支持筛选价格/区域/主题                                         |
| 用户端 | 首页     | 公告通知             | U-HOME-006     | 一期 | 展示平台活动、景区限流、系统更新等重要信息                                           |
| 用户端 | 首页     | 餐饮模块             | U-HOME-007     | 一期 | 展示热门餐饮商户及特色菜品                                                           |
| 用户端 | 首页     | 生鲜模块             | U-HOME-008     | 一期 | 展示生鲜便利商户及商品                                                               |
| 用户端 | 首页     | 文创模块             | U-HOME-009     | 一期 | 展示文创商户及商品                                                                   |
| 用户端 | 票务模块 | 票务列表             | U-TICKET-001   | 一期 | 支持多维度筛选：景区类型、日期、价格、优惠标签                                       |
| 用户端 | 票务模块 | 票务详情             | U-TICKET-002   | 一期 | 包含景区介绍、开放时间、退改规则、包含项目、用户评价                                 |
| 用户端 | 票务模块 | 票种管理             | U-TICKET-003   | 一期 | 涵盖单票、联票、套票，套票明确包含商品/服务清单及价值                                |
| 用户端 | 票务模块 | 预约购买             | U-TICKET-004   | 一期 | 支持选择日期/时段、填写游客信息、优惠券抵扣、支付方式选择                            |
| 用户端 | 票务模块 | 购票凭证             | U-TICKET-005   | 一期 | 生成电子票码/二维码，支持转发给同行人                                                |
| 用户端 | 票务模块 | 退改签管理           | U-TICKET-006   | 一期 | 按规则发送退票/改签申请，查看处理进度及退款金额                                      |
| 用户端 | 票务模块 | 购票积分             | U-TICKET-007   | 一期 | 实时到账提示+动画特效，显示积分获取明细                                              |
| 用户端 | 票务模块 | 景区二维码           | U-TICKET-008   | 一期 | 生成景区独立的二维码，扫码直接进入购票页面                                           |
| 用户端 | 票务模块 | 余票查询             | U-TICKET-009   | 一期 | 系统预留分时段限量预约功能                                                           |
| 用户端 | 票务模块 | 游客购票资格状态显示 | U-TICKET-010   | 一期 | 显示是否符合年龄、实名信息校验等                                                     |
| 用户端 | 票务模块 | 核对和支付           | U-TICKET-011   | 一期 | 支持优惠券选择、聚合支付、微信支付等                                                 |
| 用户端 | 活动模块 | 活动清单             | U-ACTIVITY-001 | 二期 | 分类展示打卡活动、积分活动、主题活动，支持筛选/搜索                                  |
| 用户端 | 活动模块 | 活动详情             | U-ACTIVITY-002 | 二期 | 包含活动规则、时间、地点、参与条件、奖励说明、参与记录                               |
| 用户端 | 活动模块 | 打卡活动             | U-ACTIVITY-003 | 二期 | 展示打卡规则、打卡点导航、打卡进度，打卡成功后弹出奖励弹窗                           |
| 用户端 | 活动模块 | 积分活动             | U-ACTIVITY-004 | 二期 | 支持积分兑换、积分任务（购票/消费/打卡/分享），包含积分规则说明                      |
| 用户端 | 活动模块 | 活动报名             | U-ACTIVITY-005 | 二期 | 需预约的活动支持报名，显示报名状态及签约方式                                         |
| 用户端 | 活动模块 | 活动收藏             | U-ACTIVITY-006 | 二期 | 可收藏感兴趣的活动，接收活动开始提醒                                                 |
| 用户端 | 消费模块 | 扫码消费             | U-CONSUME-001  | 一期 | 扫描商户二维码，展示商品列表/输入消费金额，支持钱包/积分支付                         |
| 用户端 | 消费模块 | 商户导航             | U-CONSUME-002  | 一期 | 基于定位推荐周边餐饮/零售/文创商户，显示距离/评分/优惠                               |
| 用户端 | 消费模块 | 商品浏览             | U-CONSUME-003  | 一期 | 展示商户线上商品，支持加入收藏直接购买                                               |
| 用户端 | 消费模块 | 消费积分             | U-CONSUME-004  | 一期 | 线下消费后积分实时到账，显示积分比例及明细                                           |
| 用户端 | 个人中心 | 会员信息             | U-PROFILE-001  | 一期 | 展示头像、昵称、会员等级、等级权益说明、成长值进度                                   |
| 用户端 | 个人中心 | 订单管理             | U-PROFILE-002  | 一期 | 包含全部订单、票务订单、商品订单、活动订单、支持筛选/搜索/取消                       |
| 用户端 | 个人中心 | 钱包管理             | U-PROFILE-003  | 一期 | 显示余额、支持充值（多种支付方式+充值优惠）、流水记录（筛选日期/类型）、支付密码设置 |
| 用户端 | 个人中心 | 积分管理             | U-PROFILE-004  | 一期 | 显示积分余额、积分流水（获取/消耗），包含积分兑换商城、等级权益                      |
| 用户端 | 个人中心 | 收货地址             | U-PROFILE-005  | 一期 | 支持新增/编辑/删除地址，可设置默认地址（用于文创商品邮寄）                           |
| 用户端 | 个人中心 | 消息通知             | U-PROFILE-006  | 一期 | 包含订单状态、活动提醒、积分变动、系统公告                                           |
| 用户端 | 个人中心 | 评价反馈             | U-PROFILE-007  | 二期 | 可对景区/商品/活动进行评价，提交投诉建议                                             |
| 用户端 | 个人中心 | 安全设置             | U-PROFILE-008  | 二期 | 支持账号绑定、登录密码修改、支付密码修改、隐私权限管理                               |
| 用户端 | 个人中心 | 供需管理             | U-PROFILE-009  | 二期 | 支持供需浏览、供需发布、供需报名、供需联系                                           |
| 用户端 | 个人中心 | 常用游客             | U-PROFILE-010  | 一期 | 常用游客增删改查功能                                                                 |
| 用户端 | 个人中心 | 联系客服             | U-PROFILE-011  | 一期 | 点击拨打官方客服电话                                                                 |
| 用户端 | 个人中心 | 帮助中心             | U-PROFILE-012  | 一期 | 包含常见问题（按票务、活动、消费、会员分类）                                         |
| 用户端 | 通用功能 | 搜索功能             | U-COMMON-001   | 一期 | 全局搜索景区/商品/活动/商户                                                          |
| 用户端 | 通用功能 | 二维码               | U-COMMON-002   | 一期 | 包含个人付款码、电子票码、活动签到码                                                 |
| 用户端 | 通用功能 | 帮助中心             | U-COMMON-003   | 一期 | 包含常见问题、联系客服、客服会话                                                     |

#### 2.2.2 商户端功能列表

| 终端   | 模块     | 功能         | 编号           | 分期 | 描述                                                              |
| ------ | -------- | ------------ | -------------- | ---- | ----------------------------------------------------------------- |
| 商户端 | 登录注册 | 授权登录     | M-LOGIN-001    | 一期 | 通过手机号验证码+商户资质验证登录                                 |
| 商户端 | 登录注册 | 密码找回     | M-LOGIN-002    | 一期 | 通过手机号/邮箱找回登录密码                                       |
| 商户端 | 登录注册 | 入驻申请     | M-LOGIN-003    | 一期 | 新商户提交资质材料申请入驻                                        |
| 商户端 | 商品管理 | 商品列表     | M-PRODUCT-001  | 一期 | 展示商品名称/价格/库存/状态、支持筛选/搜索                        |
| 商户端 | 商品管理 | 商品编辑     | M-PRODUCT-002  | 一期 | 新增/修改商品信息：名称、图片、价格、规格、库存、积分比例         |
| 商户端 | 商品管理 | 商品上下架   | M-PRODUCT-003  | 一期 | 支持手动上下架、定时上下架                                        |
| 商户端 | 商品管理 | 库存管理     | M-PRODUCT-004  | 一期 | 展示实时库存、支持库存预警设置、库存批量调整                      |
| 商户端 | 商品管理 | 商品分类     | M-PRODUCT-005  | 一期 | 支持自定义商品分类，便于管理和用户查找                            |
| 商户端 | 商品管理 | 商品评价     | M-PRODUCT-006  | 二期 | 查看用户对商品的评价，支持回复                                    |
| 商户端 | 活动管理 | 活动列表     | M-ACTIVITY-001 | 二期 | 展示活动名称/时间/状态/参与人数、支持筛选/搜索                    |
| 商户端 | 活动管理 | 活动创建     | M-ACTIVITY-002 | 二期 | 自定义活动规则、时间、奖励、参与条件，提交平台审核                |
| 商户端 | 活动管理 | 活动编辑     | M-ACTIVITY-003 | 二期 | 修改活动信息，已开始活动限制部分字段修改                          |
| 商户端 | 活动管理 | 活动详情     | M-ACTIVITY-004 | 二期 | 查看活动参与记录、打卡数据、奖励发放情况                          |
| 商户端 | 活动管理 | 扫码验证     | M-ACTIVITY-005 | 二期 | 扫描用户活动签到打印卡，确认参与资格/打卡通过                     |
| 商户端 | 核销管理 | 扫码核销     | M-VERIFY-001   | 一期 | 扫描用户电子票码/商品消费码，确认核销并同步状态                   |
| 商户端 | 核销管理 | 核销记录     | M-VERIFY-002   | 一期 | 查看当日/历史核销记录，支持筛选/导出                              |
| 商户端 | 核销管理 | 批量核销     | M-VERIFY-003   | 一期 | 支持导入核销的批量核销，适用于团体订单                            |
| 商户端 | 核销管理 | 核销异常处理 | M-VERIFY-004   | 一期 | 提示核销失败原因，支持手动核实核销                                |
| 商户端 | 商户管理 | 商户信息     | M-MERCHANT-001 | 一期 | 查看/编辑商户基本信息、资质材料、联系方式                         |
| 商户端 | 商户管理 | 员工管理     | M-MERCHANT-002 | 一期 | 支持员工增加或重、员工权限分配、员工绑定/解绑账号                 |
| 商户端 | 商户管理 | 经营统计     | M-MERCHANT-003 | 一期 | 展示当日/累计销售总额、销售单数、客单价、热销商品排行、销售趋势图 |
| 商户端 | 商户管理 | 订单管理     | M-MERCHANT-004 | 一期 | 包含订单列表、订单详情、订单状态跟踪、异常订单处理                |
| 商户端 | 商户管理 | 钱包管理     | M-MERCHANT-005 | 一期 | 显示余额，支持提现申请、提现记录、流水管理（筛选日期/类型）       |
| 商户端 | 商户管理 | 投诉处理     | M-MERCHANT-006 | 二期 | 查看用户投诉，提交处理方案及结果                                  |
| 商户端 | 商户管理 | 常见问题     | M-MERCHANT-007 | 一期 | 包含平台规则、操作指南、支付结算相关问题                          |
| 商户端 | 商户管理 | 退出登录     | M-MERCHANT-008 | 一期 | 退出当前商户账号                                                  |

#### 2.2.3 PC 管理端功能列表

| 终端  | 模块         | 功能           | 编号            | 分期 | 描述                                                                                        |
| ----- | ------------ | -------------- | --------------- | ---- | ------------------------------------------------------------------------------------------- |
| PC 端 | 商户管理     | 商户列表       | P-MERCHANT-001  | 一期 | 快速筛选景区/餐饮/生鲜/文创等类型，展示商户状态/等级                                        |
| PC 端 | 商户管理     | 入驻审核       | P-MERCHANT-002  | 一期 | 查看商户提交的资质材料，审核通过/驳回并填写理由                                             |
| PC 端 | 商户管理     | 商户运营       | P-MERCHANT-003  | 一期 | 支持停用/启用商户账号、加入黑名单/解除黑名单，查看商户违规记录                              |
| PC 端 | 商户管理     | 商户信息管理   | P-MERCHANT-004  | 一期 | 编辑商户基本信息、经营范围、合作类型（直营/联营/加盟）                                      |
| PC 端 | 商户管理     | 员工管理       | P-MERCHANT-005  | 一期 | 查看商户员工列表、重置员工密码、调整员工权限                                                |
| PC 端 | 设备管理     | 设备列表       | P-DEVICE-001    | 一期 | 支持设备增加或重、展示设备型号/编号/归属商户/状态                                           |
| PC 端 | 设备管理     | 设备配置       | P-DEVICE-002    | 一期 | 支持设备归属和定位匹配、设备参数设置                                                        |
| PC 端 | 设备管理     | 运维管理       | P-DEVICE-003    | 一期 | 监控设备状态（在线/离线/故障），支持故障上报、维修工单管理、运维记录                        |
| PC 端 | 设备管理     | 设备统计       | P-DEVICE-004    | 二期 | 展示设备使用率、故障发生率、各区域设备分布                                                  |
| PC 端 | 用户管理     | 用户列表       | P-USER-001      | 一期 | 展示用户 ID/视频/手机号/会员等级/注册时间，支持筛选/搜索                                    |
| PC 端 | 用户管理     | 用户详情       | P-USER-002      | 一期 | 查看用户基本信息、订单记录、积分流水、消费习惯                                              |
| PC 端 | 用户管理     | 用户行为分析   | P-USER-003      | 二期 | 分析用户访问路径、热门功能访问频次、消费偏好                                                |
| PC 端 | 用户管理     | 异常用户处理   | P-USER-004      | 一期 | 支持冻结/解冻用户账号，查看用户投诉记录                                                     |
| PC 端 | 商品管理     | 分类管理       | P-PRODUCT-001   | 一期 | 支持商品一级/二级分类辅助改善，设置分类排序                                                 |
| PC 端 | 商品管理     | 票种管理       | P-PRODUCT-002   | 一期 | 管理单票/联票/套票，设置套票组合规则、价格核算                                              |
| PC 端 | 商品管理     | 商品审核       | P-PRODUCT-003   | 一期 | 审核商户上架商品，检查商品信息/图片/价格合规性                                              |
| PC 端 | 商品管理     | 商品监控       | P-PRODUCT-004   | 二期 | 查看商品销售数据、库存预警、下架违规商品                                                    |
| PC 端 | 商品管理     | 积分赋值       | P-PRODUCT-005   | 一期 | 设置不同类型商品/商户的积分比例，支持批量调整                                               |
| PC 端 | 商户商品管理 | 商品上下架审核 | P-MER-PROD-001  | 一期 | 审核商户商品上架/下架申请                                                                   |
| PC 端 | 商户商品管理 | 积分比例管理   | P-MER-PROD-002  | 一期 | 按商户类型（直营/联营/加盟）设置积分赋值规则                                                |
| PC 端 | 商户商品管理 | 供应链管理     | P-MER-PROD-003  | 二期 | 设置商户供应链隶属关系，监控商品采购渠道                                                    |
| PC 端 | 商户商品管理 | 分账管理       | P-MER-PROD-004  | 一期 | 按商户类型设置分账比例（直营 100%、联营利润分配、加盟金额比例），支持分账规则编辑/生效/失效 |
| PC 端 | 订单管理     | 订单列表       | P-ORDER-001     | 一期 | 多维度筛选：订单类型/状态/时间/商户/用户，支持搜索订单号                                    |
| PC 端 | 订单管理     | 订单详情       | P-ORDER-002     | 一期 | 查看订单商品/服务信息、支付信息、核销状态、退款记录                                         |
| PC 端 | 订单管理     | 异常订单处理   | P-ORDER-003     | 一期 | 支持订单取消、退款审核、纠纷订单仲裁                                                        |
| PC 端 | 订单管理     | 订单统计       | P-ORDER-004     | 二期 | 统计订单总量、销售额、核销率、退款率，按时间/商户/商品维度分析                              |
| PC 端 | 活动管理     | 活动列表       | P-ACTIVITY-001  | 二期 | 展示活动名称/发起商户/时间/状态/参与人数，支持筛选/搜索                                     |
| PC 端 | 活动管理     | 活动审核       | P-ACTIVITY-002  | 二期 | 审核商户活动创建申请，检查活动规则/奖励合规性                                               |
| PC 端 | 活动管理     | 规则管理       | P-ACTIVITY-003  | 二期 | 创建/编辑平台级活动规则模板，供商户复用                                                     |
| PC 端 | 活动管理     | 打卡管理       | P-ACTIVITY-004  | 二期 | 查看活动打卡数据、打卡点使用率，处理异常打卡                                                |
| PC 端 | 活动管理     | 活动数据统计   | P-ACTIVITY-005  | 二期 | 统计活动参与人数、转化率、用户留存率、活动 ROI 分析                                         |
| PC 端 | 财务管理     | 分账管理       | P-FINANCE-001   | 一期 | 查询分账记录，监控分账规则执行，处理分账异常                                                |
| PC 端 | 财务管理     | 流水管理       | P-FINANCE-002   | 一期 | 展示平台总流水、商户流水、用户流水，支持筛选/导出/对账                                      |
| PC 端 | 财务管理     | 结算管理       | P-FINANCE-003   | 一期 | 设置商户结算周期，生成/审核/支付结算单，查询结算记录                                        |
| PC 端 | 财务管理     | 发票管理       | P-FINANCE-004   | 二期 | 审核商户发票申请，查看发票开具记录，处理发票作废                                            |
| PC 端 | 财务管理     | 财务报表       | P-FINANCE-005   | 二期 | 提供营业报表、利润报表、分账报表，支持按日/周/月/年查看                                     |
| PC 端 | 系统管理     | 权限管理       | P-SYSTEM-001    | 一期 | 分配用户角色权限，细化功能模块操作权限                                                      |
| PC 端 | 系统管理     | 角色管理       | P-SYSTEM-002    | 一期 | 支持角色增加或改写，预设管理员/运营员/务等角色模板                                          |
| PC 端 | 系统管理     | 日志管理       | P-SYSTEM-003    | 一期 | 查询/导出操作日志、登录日志、错误日志，支持按时间/用户筛选                                  |
| PC 端 | 系统管理     | 数据字典管理   | P-SYSTEM-004    | 一期 | 配置系统基础参数（如会员等级值、积分兑换比例基数）                                          |
| PC 端 | 系统管理     | 备份恢复       | P-SYSTEM-005    | 一期 | 支持数据定时备份、手动备份、备份数据恢复                                                    |
| PC 端 | 供需管理     | 供需发布       | P-SUPPLY-001    | 二期 | 审核用户/商户发布的供需信息，确保信息合规                                                   |
| PC 端 | 供需管理     | 供需管理       | P-SUPPLY-002    | 二期 | 展示供需信息列表、分类展示、更新状态                                                        |
| PC 端 | 供需管理     | 报名记录       | P-SUPPLY-003    | 二期 | 查看供需报名记录，支持导出和联系对接                                                        |
| PC 端 | 接口管理     | 支付接口       | P-INTERFACE-001 | 一期 | 对接微信/支付宝/银联等支付渠道，监控接口状态                                                |
| PC 端 | 接口管理     | 设备接口       | P-INTERFACE-002 | 一期 | 打通机机/手持验票设备接口，监控数据同步                                                     |
| PC 端 | 接口管理     | 人脸接口       | P-INTERFACE-003 | 二期 | 管理人脸库，对接人脸识别接口，支持刷脸入园/消费                                             |
| PC 端 | 接口管理     | 接口文档       | P-INTERFACE-004 | 一期 | 提供接口调用说明、参数规范、错误码解释                                                      |

---

## 3. 务实渐进式技术架构方案（v1.2 更新）

### 3.1 架构设计核心理念

**核心原则：避免过度设计，务实渐进**

本项目作为区域性文旅平台，技术架构应遵循：

1. **稳定可靠**优先于技术新颖
2. **团队可控**优先于技术全面
3. **成本合理**优先于架构完美
4. **渐进演进**优先于一步到位

### 3.2 整体架构设计（四服务精简模型）

#### 3.2.1 架构总览图

```mermaid
graph TB
    subgraph "客户端层 Client Layer"
        C1[用户端小程序<br/>Uni-app/Taro]
        C2[商户端小程序<br/>Uni-app/Taro]
        C3[PC管理端<br/>Vue3/React]
        C4[硬件设备<br/>Android定制]
    end

    subgraph "接入层 Gateway Layer"
        G1[CDN/WAF<br/>云服务商]
        G2[API网关<br/>Nginx/Kong/云网关]
        G3[负载均衡<br/>SLB]
    end

    subgraph "业务服务层（4核心服务）"
        S1[核心业务服务<br/>用户/票务/订单/活动/积分]
        S2[支付与财务服务<br/>支付/结算/分账/发票]
        S3[运营与商户服务<br/>商户/核销/设备/经营]
        S4[数据与消息服务<br/>消息/报表/日志]
    end

    subgraph "数据层 Data Layer"
        D1[(MySQL 8.0<br/>主从+读写分离)]
        D2[(Redis Cluster<br/>缓存集群)]
        D3[(ClickHouse<br/>分析数据库)]
        D4[OSS/CDN<br/>对象存储]
        D5[RocketMQ<br/>消息队列]
    end

    subgraph "基础设施 Infrastructure"
        I1[K8s托管集群<br/>ACK/TKE]
        I2[监控告警<br/>Prometheus+Grafana]
        I3[日志系统<br/>Loki]
        I4[CI/CD<br/>GitLab+Jenkins]
    end

    C1 --> G1
    C2 --> G1
    C3 --> G1

    G1 --> G2 --> G3

    G3 --> S1
    G3 --> S2
    G3 --> S3
    G3 --> S4

    S1 --> D1
    S1 --> D2
    S2 --> D1
    S3 --> D1

    S4 --> D3
    S1 --> D5
    S2 --> D5

    S1 --> I2
    S2 --> I2
    S3 --> I3

    S1 --> I1
    S2 --> I1
```

#### 3.2.2 四服务拆分设计（表 T-3.2.2）

| 服务名称           | 包含核心模块                                                         | 拆分理由                                   | 技术特点                                   |
| ------------------ | -------------------------------------------------------------------- | ------------------------------------------ | ------------------------------------------ |
| **核心业务服务**   | 用户中心、票务管理、订单管理、活动管理、积分系统、商品管理、供需模块 | 强事务关联，数据一致性要求高，适合集中管理 | 事务密集，RPC 调用多，需要强一致性         |
| **支付与财务服务** | 支付网关、钱包管理、结算系统、分账管理、发票管理                     | 资金相关，安全等级和监管要求不同           | 高安全要求，独立审计，与第三方支付对接     |
| **运营与商户服务** | 商户管理、员工管理、核销系统、设备管理、经营统计                     | 面向 B 端，功能相对独立，并发模式不同      | 长连接多（设备），文件操作多，B 端操作复杂 |
| **数据与消息服务** | 消息推送（短信/推送）、数据统计/报表、日志分析、定时任务             | 异步处理，计算密集型，可独立伸缩           | 异步任务，大数据处理，IO 密集型            |

**优势分析：**

- **运维简单**：4 个服务 vs 13+个微服务，复杂度大幅降低
- **边界清晰**：按资金、商户、核心交易、数据划分，符合业务认知
- **独立伸缩**：各服务可根据压力独立扩容
- **演进灵活**：未来任一服务可按需进一步拆分

### 3.3 技术栈选型（务实版）

#### 3.3.1 前端技术栈（表 T-3.3.1）

| 终端             | 推荐方案                | 替代方案              | 选择理由                                                 |
| ---------------- | ----------------------- | --------------------- | -------------------------------------------------------- |
| **用户端小程序** | Uni-app（Vue3 语法）    | Taro（React 语法）    | 一套代码多端发布（微信/支付宝/H5），开发效率高，生态成熟 |
| **商户端小程序** | Uni-app（Vue3 语法）    | Taro（React 语法）    | 与用户端技术栈统一，降低维护成本                         |
| **PC 管理端**    | Vue 3 + Element Plus    | React + Ant Design    | Vue 学习曲线平缓，Element Plus 组件丰富，适合管理后台    |
| **硬件设备端**   | Android 原生 + 轻量 SDK | Flutter（如需跨平台） | 性能要求高，需要直接硬件访问，原生开发更可靠             |

#### 3.3.2 后端技术栈（表 T-3.3.2）

| 组件         | 推荐方案                                | 版本              | 部署模式      | 关键考量                                     |
| ------------ | --------------------------------------- | ----------------- | ------------- | -------------------------------------------- |
| **开发语言** | **Go**（推荐）或 **Java**（如团队熟悉） | Go 1.21 / Java 17 | 容器化部署    | Go 部署简单性能好，Java 生态丰富             |
| **Web 框架** | Gin（Go）或 Spring Boot（Java）         | 最新稳定版        | 微服务架构    | Gin 轻量高效，Spring Boot 生态成熟           |
| **API 网关** | Nginx/Kong 或 **云厂商 API 网关**       | 最新稳定版        | 独立部署/托管 | 成熟稳定，无需自研网关高可用                 |
| **服务发现** | Consul 或 **K8s Service**               | Consul 1.15+      | 集群部署      | Consul 轻量成熟，服务不多时 K8s 原生能力足够 |
| **配置中心** | Apollo 或 **Nacos**（如选 Java）        | 最新稳定版        | 独立集群      | 功能完善，支持配置热更新                     |
| **消息队列** | **RocketMQ**                            | 5.0+              | 集群部署      | 阿里系，事务消息特性对交易系统友好           |
| **任务调度** | XXL-JOB                                 | 2.4.0             | 独立部署      | 功能完善，管理界面友好                       |

#### 3.3.3 数据存储技术栈（表 T-3.3.3）

| 存储类型       | 推荐方案              | 版本    | 部署模式          | 使用场景                            |
| -------------- | --------------------- | ------- | ----------------- | ----------------------------------- |
| **主关系库**   | MySQL 8.0             | 8.0.34+ | 一主两从+读写分离 | 所有核心业务数据，强一致性要求      |
| **缓存数据库** | Redis                 | 7.0+    | Cluster 6 节点    | 会话、热点数据、库存预扣、分布式锁  |
| **分析数据库** | **ClickHouse**        | 23.8+   | 单机或轻量集群    | 所有报表、运营分析、用户行为分析    |
| **对象存储**   | 阿里云 OSS/腾讯云 COS | -       | 标准+低频存储     | 图片、视频、文件存储，配合 CDN 加速 |
| **搜索引擎**   | Elasticsearch（按需） | 8.10+   | 3 节点集群        | 仅当有复杂全文检索需求时使用        |

**数据流设计：**

```
MySQL（业务库） → Binlog同步/Canal → ClickHouse（分析库）
业务操作 → 写MySQL + 发消息 → 异步处理 → 更新ClickHouse
```

#### 3.3.4 运维监控技术栈（表 T-3.3.4）

| 领域         | 推荐方案              | 用途             | 部署复杂度         |
| ------------ | --------------------- | ---------------- | ------------------ |
| **容器编排** | 阿里云 ACK/腾讯云 TKE | K8s 托管集群     | 低（云厂商托管）   |
| **服务监控** | Prometheus + Grafana  | 指标监控、可视化 | 中                 |
| **日志系统** | **Loki + Grafana**    | 日志收集、查询   | 低（相比 EFK）     |
| **链路追踪** | Jaeger（按需）        | 分布式调用追踪   | 中（初期可不使用） |
| **API 文档** | Swagger/OpenAPI       | 接口文档、测试   | 低                 |
| **CI/CD**    | GitLab CI + Jenkins   | 自动化构建部署   | 中                 |

### 3.4 渐进式架构演进路径

#### 3.4.1 三阶段实施计划（表 T-3.4.1）

| 阶段         | 时间      | 架构形态                                  | 核心目标                       | 技术重点                                                                            |
| ------------ | --------- | ----------------------------------------- | ------------------------------ | ----------------------------------------------------------------------------------- |
| **第一阶段** | 1-3 个月  | **模块化单体** 或 **2 服务（核心+支付）** | 快速上线核心功能，验证商业模式 | 1. 核心购票-支付-核销闭环<br>2. 基础用户/商户功能<br>3. 最小可用监控                |
| **第二阶段** | 4-6 个月  | **四服务架构成型**                        | 功能完善，架构优化，准备规模化 | 1. 拆分为四服务<br>2. 引入 ClickHouse 分析<br>3. 完善监控告警<br>4. 上 K8s 托管集群 |
| **第三阶段** | 7-12 个月 | **四服务优化+智能扩展**                   | 性能优化，数据驱动，智能运营   | 1. 服务性能调优<br>2. 数据报表完善<br>3. 智能推荐试点<br>4. 开放平台准备            |

#### 3.4.2 第一阶段详细设计（模块化单体起点）

```mermaid
graph TB
    subgraph "单体应用（模块化设计）"
        M1[用户模块]
        M2[票务模块]
        M3[订单模块]
        M4[支付模块]
        M5[活动模块]
        M6[商户模块]
        M7[数据模块]

        M1 --> M2
        M2 --> M3
        M3 --> M4
        M4 --> M5
        M5 --> M6
        M6 --> M7
    end

    subgraph "数据库层"
        DB1[(MySQL主库)]
        DB2[(Redis缓存)]
    end

    subgraph "部署层"
        D1[Docker容器]
        D2[Nginx反向代理]
    end

    客户端 --> D2 --> D1 --> 单体应用
    单体应用 --> DB1
    单体应用 --> DB2
```

**第一阶段技术栈：**

- **后端**： Java + Spring Boot（单体应用）
- **数据库**：MySQL（单实例或主从）+ Redis（单实例）
- **部署**：Docker Compose 或 单台云服务器
- **监控**：基础 Prometheus + 云监控

### 3.5 关键设计决策说明

#### 3.5.1 为什么选择四服务而非微服务集群？

1. **复杂度控制**：13+个微服务需要完善的治理工具（注册中心、配置中心、网关、链路追踪），运维成本高
2. **团队能力匹配**：中小团队更容易掌握 4 个服务的运维和开发
3. **事务处理简化**：减少分布式事务场景，大部分事务在核心服务内完成
4. **网络开销减少**：服务间调用减少，延迟降低

#### 3.5.2 为什么推荐 Go 或二选一？

- **如果团队有 Java 基础**：继续用 Java + Spring Boot，技术栈稳定，招聘容易
- **如果从零开始或追求性能**：选择 Go，部署简单，并发性能好，资源占用低
- **不建议同时使用两种语言**：增加团队学习成本和维护难度

#### 3.5.3 为什么用 ClickHouse 替代多个分析组件？

- **一专多能**：ClickHouse 既能做时序数据分析（替代 TDengine），又能做复杂报表查询（替代 ES 部分功能）
- **性能卓越**：分析查询性能远超 MySQL，适合大数据量场景
- **运维简单**：单机或小集群就能支撑很大数据量
- **成本节约**：减少多个数据库的运维和学习成本

#### 3.5.4 为什么建议使用云托管服务？

- **减轻运维负担**：云厂商的托管 K8s、托管数据库、CDN、WAF 等
- **专业支持**：云厂商提供专业维护和故障处理
- **弹性伸缩**：按需付费，灵活扩容
- **安全性**：云平台的基础安全防护更完善

### 3.6 成本与资源预估

#### 3.6.1 基础设施成本（表 T-3.6.1）

| 阶段         | 服务器资源              | 存储与网络                         | 云服务费用            | 月均成本估算         |
| ------------ | ----------------------- | ---------------------------------- | --------------------- | -------------------- |
| **第一阶段** | 2 台 4C8G 云服务器      | 100GB 云硬盘，10M 带宽             | 基础云监控，OSS 存储  | 约 1500-2000 元/月   |
| **第二阶段** | K8s 集群（4 节点 4C8G） | 200GB 云硬盘，20M 带宽，Redis 集群 | 托管 K8s，CDN，WAF    | 约 5000-8000 元/月   |
| **第三阶段** | K8s 集群（6-8 节点）    | 500GB+云硬盘，50M+带宽             | 全量云服务，DDoS 防护 | 约 10000-20000 元/月 |

#### 3.6.2 人力投入建议（表 T-3.6.2）

| 角色              | 第一阶段     | 第二阶段 | 第三阶段 | 主要职责                       |
| ----------------- | ------------ | -------- | -------- | ------------------------------ |
| **后端开发**      | 2-3 人       | 3-4 人   | 4-5 人   | 服务开发、API 设计、数据库设计 |
| **前端开发**      | 2 人         | 2-3 人   | 3 人     | 小程序、PC 端开发              |
| **测试工程师**    | 1 人         | 2 人     | 2-3 人   | 功能测试、性能测试、自动化     |
| **运维工程师**    | 0.5 人（兼） | 1 人     | 1-2 人   | 部署、监控、故障处理           |
| **产品/项目经理** | 1 人         | 1-2 人   | 2 人     | 需求管理、项目协调             |

**总计人力**：第一阶段 5-7 人，第二阶段 8-11 人，第三阶段 12-15 人。

---

## 4. 数据模型设计（P0 优先级）

### 4.1 核心实体关系图

```mermaid
erDiagram
    User ||--o{ Order : places
    User ||--o{ Address : has
    User ||--o{ UserCoupon : owns
    User ||--o{ UserPoint : accumulates

    Merchant ||--o{ Product : sells
    Merchant ||--o{ Activity : organizes
    Merchant ||--o{ Employee : employs
    Merchant ||--o{ Settlement : receives

    Order ||--o{ OrderItem : contains
    Order ||--o{ Payment : generates
    Order ||--o{ Refund : may_have

    Product ||--o{ ProductSku : has_variants
    Product ||--o{ ProductStock : has_stock

    Activity ||--o{ ActivityParticipant : has_participants
    Activity ||--o{ ActivityCheckpoint : has_checkpoints

    Ticket ||--o{ TicketVerification : verified_by

    User {
        bigint id PK "用户ID"
        string phone "手机号"
        string nickname "昵称"
        string avatar_url "头像"
        int member_level "会员等级"
        datetime register_time "注册时间"
        datetime last_login_time "最后登录"
        int status "状态:0正常1冻结"
    }

    Order {
        string order_no PK "订单号"
        bigint user_id FK "用户ID"
        int order_type "订单类型:1门票2商品3活动"
        decimal total_amount "总金额"
        int status "状态"
        datetime create_time "创建时间"
        datetime pay_time "支付时间"
    }
```

### 4.3 数据一致性方案

#### 4.3.1 分布式事务场景（表 T-4.3.1）

| 业务场景     | 一致性要求 | 技术方案                  | 补偿措施              |
| ------------ | ---------- | ------------------------- | --------------------- |
| **订单支付** | 强一致性   | 本地事务+消息队列最终一致 | 定时任务检查+人工核查 |
| **积分发放** | 最终一致性 | 消息队列+本地事务表       | 定时任务补偿          |
| **库存扣减** | 强一致性   | 数据库事务+乐观锁         | 库存回滚+告警通知     |
| **退款处理** | 最终一致性 | 状态机+异步处理           | 人工干预+重试机制     |
| **结算处理** | 最终一致性 | 批处理+对账机制           | 差异对账+人工调账     |

#### 4.3.2 库存扣减方案示例

```java
// 伪代码：库存扣减的分布式事务处理
@Service
public class InventoryService {

    @Autowired
    private ProductSkuMapper skuMapper;

    @Transactional
    public boolean deductInventory(Long skuId, Integer quantity) {
        // 1. 查询当前库存（加行锁）
        ProductSku sku = skuMapper.selectForUpdate(skuId);

        // 2. 校验库存
        if (sku.getStockAvailable() < quantity) {
            throw new BusinessException("库存不足");
        }

        // 3. 扣减可用库存，增加锁定库存
        int rows = skuMapper.deductInventory(skuId, quantity);
        if (rows == 0) {
            throw new OptimisticLockException("库存并发修改");
        }

        // 4. 记录库存流水
        inventoryFlowMapper.insert(createInventoryFlow(skuId, quantity));

        return true;
    }
}
```

#### 4.3.3 数据同步方案

```yaml
# Canal配置示例（MySQL到ClickHouse数据同步）
canal:
  server:
    mode: tcp
    host: 127.0.0.1
    port: 11111
  destination: example
  filter: .*\\..*

# 同步规则
sync_rules:
  - source_table: order
    target_table: order_analysis
    sync_columns:
      [
        "order_no",
        "user_id",
        "total_amount",
        "pay_amount",
        "order_status",
        "create_time",
      ]
    sync_condition: "order_status IN (2,5)" # 只同步已完成和已退款订单

  - source_table: user
    target_table: user_analysis
    sync_columns:
      ["id", "phone", "member_level", "total_points", "register_time"]
    sync_condition: "status = 0" # 只同步正常用户
```

---

## 5. 核心业务流程（P0 优先级）

### 5.1 购票业务流程

#### 5.1.1 正常购票流程（图 F-5.1.1）

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as API网关
    participant T as 票务服务
    participant O as 订单服务
    participant P as 支付服务
    participant I as 积分服务
    participant M as 消息服务

    Note over U,F: 1. 查询票务信息
    U->>F: 选择景区/票种/日期
    F->>G: GET /api/tickets/available
    G->>T: 查询余票
    T-->>F: 返回余票和价格信息

    Note over U,F: 2. 创建订单
    U->>F: 选择游客/票数，点击预订
    F->>G: POST /api/orders
    G->>O: 创建订单
    O->>T: 预扣库存(锁定)
    O->>O: 生成订单号，计算金额
    O-->>F: 返回订单详情

    Note over U,F: 3. 发起支付
    U->>F: 确认订单，点击支付
    F->>G: POST /api/payments/create
    G->>P: 创建支付
    P-->>F: 返回支付参数(预支付ID等)
    F->>第三方支付: 调起支付SDK

    Note over U,F: 4. 支付回调处理
    第三方支付->>P: 支付结果回调
    P->>O: 更新订单为已支付
    P->>T: 确认扣减库存
    P->>I: 发放积分
    P->>M: 发送支付成功通知
    M-->>U: 短信/推送通知

    Note over U,F: 5. 获取电子票
    U->>F: 查看订单/电子票
    F->>G: GET /api/orders/{orderNo}/tickets
    G->>O: 查询订单票券
    O-->>F: 返回电子票二维码
```

#### 5.1.2 购票流程异常处理（表 T-5.1.2）

| 异常场景         | 触发条件               | 用户提示                                         | 系统处理               | 恢复策略                   |
| ---------------- | ---------------------- | ------------------------------------------------ | ---------------------- | -------------------------- |
| **库存不足**     | 多人同时购买同一票种   | "当前票种已售罄，请选择其他票种或时间"           | 返回库存不足错误码     | 释放锁定库存，建议用户刷新 |
| **支付超时**     | 支付操作超过 30 秒     | "支付超时，请重新尝试"                           | 订单状态保持待支付     | 用户可重新支付或取消订单   |
| **重复支付**     | 同一订单支付两次       | "检测到重复支付，多余款项将在 24 小时内原路退回" | 识别重复支付，记录异常 | 自动退款处理               |
| **网络异常**     | 支付回调失败           | "支付结果确认中，请稍后查看订单状态"             | 标记订单为支付中       | 定时任务轮询支付状态       |
| **身份验证失败** | 身份证信息不合法       | "身份证信息验证失败，请核对后重新输入"           | 拒绝创建订单           | 提示用户检查身份证信息     |
| **参数校验失败** | 必填参数缺失或格式错误 | "请完善相关信息后重试"                           | 返回参数错误码         | 前端重新校验               |
| **系统异常**     | 服务内部错误           | "系统繁忙，请稍后重试"                           | 记录异常日志，告警通知 | 自动重试或人工干预         |

#### 5.1.3 游客信息校验流程

```mermaid
graph TD
    A[开始填写游客信息] --> B{是否实名购票}
    B -->|是| C[填写姓名身份证]
    B -->|否| D[填写姓名即可]

    C --> E[调用公安接口校验]
    E --> F{校验是否通过}
    F -->|是| G[允许购票]
    F -->|否| H[提示身份信息错误]

    D --> I[仅校验姓名格式]
    I --> G

    H --> J{是否重试}
    J -->|是| C
    J -->|否| K[结束流程]

    G --> L[进入支付环节]
    L --> M[完成购票]
```

### 5.2 退改签业务流程

#### 5.2.1 退款流程规则（表 T-5.2.1）

| 退款时间点            | 退款比例 | 手续费       | 计算公式                                 | 示例(订单 100 元) |
| --------------------- | -------- | ------------ | ---------------------------------------- | ----------------- |
| **游玩日前 7 天以上** | 100%     | 0 元         | 退款金额 = 实付金额                      | 退款 100 元       |
| **游玩日前 3-7 天**   | 80%      | 订单金额 5%  | 退款金额 = 实付金额 ×80% - 订单金额 ×5%  | 退款 80-5=75 元   |
| **游玩日前 1-3 天**   | 50%      | 订单金额 10% | 退款金额 = 实付金额 ×50% - 订单金额 ×10% | 退款 50-10=40 元  |
| **游玩当日**          | 0%       | -            | 不支持退款                               | 退款 0 元         |
| **特殊情况**          | 100%     | 平台承担     | 全额退款                                 | 退款 100 元       |

**特殊情况说明**：

1. 景区临时关闭（天气原因、突发事件）
2. 用户提供医院证明等不可抗力
3. 平台系统问题导致无法使用
4. 政府政策要求

#### 5.2.2 改签流程设计

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant O as 订单服务
    participant T as 票务服务
    participant P as 支付服务

    U->>F: 进入订单详情，点击"改签"
    F->>G: GET /api/tickets/available?date=新日期
    G->>T: 查询新日期余票
    T-->>F: 返回可改签的票种和价格

    alt 改签到更贵票种
        U->>F: 选择新票种，确认改签
        F->>G: POST /api/orders/{orderNo}/change
        G->>O: 发起改签申请
        O->>T: 释放旧票库存
        O->>T: 锁定新票库存
        O->>P: 计算差价，生成补支付订单
        O-->>F: 返回需补差价金额
        F->>第三方支付: 支付差价
        第三方支付->>P: 支付回调
        P->>O: 更新订单为改签成功
        P->>O: 发放新电子票
    else 改签到更便宜票种
        U->>F: 选择新票种，确认改签
        F->>G: POST /api/orders/{orderNo}/change
        G->>O: 发起改签申请
        O->>T: 释放旧票库存
        O->>T: 锁定新票库存
        O->>P: 计算差价，生成退款记录
        O-->>F: 返回将退款金额
        P->>第三方支付: 发起退款
        第三方支付->>U: 退款到账
    end
```

#### 5.2.3 退改签状态机设计

```mermaid
stateDiagram-v2
    [*] --> 正常订单

    正常订单 --> 申请退款: 用户申请退款
    申请退款 --> 退款审核中: 提交申请
    退款审核中 --> 退款已通过: 审核通过
    退款审核中 --> 退款已拒绝: 审核拒绝
    退款已通过 --> 退款处理中: 发起退款
    退款处理中 --> 退款已完成: 退款成功
    退款处理中 --> 退款失败: 退款失败
    退款失败 --> 退款处理中: 重新发起

    正常订单 --> 申请改签: 用户申请改签
    申请改签 --> 改签审核中: 提交申请
    改签审核中 --> 改签已通过: 审核通过
    改签审核中 --> 改签已拒绝: 审核拒绝
    改签已通过 --> 改签处理中: 处理改签
    改签处理中 --> 改签已完成: 改签成功
    改签处理中 --> 改签失败: 改签失败
    改签失败 --> 改签处理中: 重新处理

    退款已完成 --> [*]
    改签已完成 --> [*]
    退款已拒绝 --> 正常订单
    改签已拒绝 --> 正常订单
```

### 5.3 核销业务流程

#### 5.3.1 核销状态机设计（图 F-5.3.1）

```
待核销 ──扫描二维码──→ 验证中
   │                      │
   │                      ├─验证通过──→ 已核销
   │                      │
   │                      ├─验证失败──→ 核销异常
   │                      │    │
   │                      │    └─人工处理─→ 已核销/已作废
   │                      │
   │                      └─重复核销──→ 已核销(提示重复)
   │
   └─超过有效期──→ 已过期
```

#### 5.3.2 批量核销流程

```mermaid
sequenceDiagram
    participant O as 核销员
    participant D as 核销设备
    participant G as 网关
    participant V as 核销服务
    participant O as 订单服务
    participant M as 消息服务

    O->>D: 1. 登录商户账号
    D->>G: 认证获取token
    G-->>D: 返回访问令牌

    O->>D: 2. 进入批量核销页面
    D->>G: GET /api/verification/batch/template
    G-->>D: 下载核销模板Excel

    O->>D: 3. 填写核销码，上传文件
    D->>G: POST /api/verification/batch (multipart/form-data)
    G->>V: 批量核销请求

    par 并行核销处理
        V->>V: 解析Excel，分组处理
        V->>O: 查询订单状态
        V->>V: 验证核销码有效性
        V->>V: 更新核销状态
        V->>M: 发送核销通知
    end

    V-->>D: 返回核销结果文件
    D->>O: 显示核销结果
    Note over D: 成功:绿色 失败:红色 异常:黄色
```

#### 5.3.3 核销异常处理（表 T-5.3.3）

| 异常类型         | 错误码 | 用户提示                     | 商户操作                 | 系统处理               |
| ---------------- | ------ | ---------------------------- | ------------------------ | ---------------------- |
| **二维码失效**   | 1001   | "二维码已失效，请刷新后重试" | 手动输入核销码           | 记录失效原因，审计日志 |
| **重复核销**     | 1002   | "该票券已于 XX 时间核销"     | 查看核销记录             | 提示核销详情，防止纠纷 |
| **票券过期**     | 1003   | "票券已过期，无法核销"       | 建议用户联系客服         | 自动标记为过期状态     |
| **设备离线**     | 1004   | "设备网络异常，正在尝试重连" | 检查网络连接             | 本地缓存核销记录       |
| **权限不足**     | 1005   | "无核销权限，请联系管理员"   | 申请权限或切换账号       | 记录未授权访问         |
| **系统异常**     | 5001   | "系统繁忙，请稍后重试"       | 稍后重试或联系技术支持   | 记录异常堆栈，告警通知 |
| **票种不匹配**   | 1006   | "当前设备不支持此票种核销"   | 使用正确设备或联系管理员 | 记录设备权限           |
| **游客信息不符** | 1007   | "游客信息与票券信息不符"     | 核对游客身份             | 记录异常，需要人工审核 |

### 5.4 积分业务流程

#### 5.4.1 积分获取规则（表 T-5.4.1）

| 积分来源     | 积分比例    | 上限规则           | 生效时间       | 备注                 |
| ------------ | ----------- | ------------------ | -------------- | -------------------- |
| **购票消费** | 1%-5%可配置 | 单笔最高 1000 积分 | 支付成功后     | 按票种设置不同比例   |
| **商品消费** | 1%-3%可配置 | 无上限             | 确认收货后     | 生鲜类 1%，文创类 3% |
| **每日签到** | 10 积分     | 连续签到递增       | 每日首次签到   | 连续 7 天额外奖励    |
| **活动参与** | 50-500 积分 | 按活动设置         | 活动完成后     | 打卡活动、任务活动   |
| **评价反馈** | 20 积分     | 每订单一次         | 提交评价后     | 带图评价额外+10      |
| **邀请好友** | 100 积分/人 | 每月上限 500       | 好友首次消费   | 好友需完成实名       |
| **分享内容** | 5 积分/次   | 每日上限 50        | 分享后好友查看 | 需有实际查看行为     |
| **完善信息** | 50 积分     | 一次性             | 完善个人信息后 | 实名认证额外+100     |

#### 5.4.2 积分消耗场景（表 T-5.4.2）

| 消耗场景       | 积分比例      | 限制条件             | 有效期       | 备注                  |
| -------------- | ------------- | -------------------- | ------------ | --------------------- |
| **门票抵扣**   | 100 积分=1 元 | 最高抵扣订单金额 50% | 无限制       | 部分特价票不可用      |
| **商品兑换**   | 按商品设置    | 库存限制             | 兑换时生效   | 实物商品需付邮费      |
| **优惠券兑换** | 固定比例      | 限量发放             | 优惠券有效期 | 如 500 积分换 10 元券 |
| **活动参与**   | 报名费用      | 活动要求             | 活动期间     | 消耗型，不退积分      |
| **抽奖活动**   | 50 积分/次    | 每日限 5 次          | 即时生效     | 概率获得实物奖品      |
| **会员升级**   | 升级费用      | 一次性               | 永久有效     | 升级后享受更多权益    |
| **特权购买**   | 按特权设置    | 特权有效期           | 购买时生效   | 如优先购票权          |

#### 5.4.3 积分风控策略

```java
// 伪代码：积分发放风控检查
@Service
public class PointRiskControlService {

    // 积分获取频率限制
    public boolean checkFrequencyLimit(Long userId, String pointSource) {
        String key = String.format("point:limit:%s:%s:%s",
            userId, pointSource, LocalDate.now());

        Long count = redisTemplate.opsForValue().increment(key, 1);
        if (count == 1) {
            redisTemplate.expire(key, 24, TimeUnit.HOURS);
        }

        // 不同来源有不同的日上限
        Map<String, Integer> dailyLimits = Map.of(
            "SIGN_IN", 1,
            "ORDER_COMMENT", 10,
            "INVITE_FRIEND", 10,
            "SHARE_CONTENT", 10
        );

        return count <= dailyLimits.getOrDefault(pointSource, 100);
    }

    // 防刷单检测
    public boolean checkAntiCheating(Long userId, BigDecimal amount, Integer points) {
        // 1. 检查用户历史行为
        UserPointHistory history = pointHistoryMapper.selectRecentByUser(userId);

        // 2. 异常模式识别
        // - 短时间内大量获取积分
        // - 积分与消费金额比例异常
        // - 多个账号相似行为

        // 3. 风险评分计算
        int riskScore = calculateRiskScore(userId, amount, points);

        return riskScore < RISK_THRESHOLD;
    }

    // 积分有效期管理
    public void managePointExpiration() {
        // 查找即将过期的积分
        List<UserPoint> expiringPoints = pointMapper.findExpiringPoints(LocalDate.now().plusDays(7));

        for (UserPoint point : expiringPoints) {
            // 发送过期提醒
            messageService.sendPointExpireReminder(point.getUserId(), point.getPointAmount(), point.getExpireTime());
        }

        // 自动清理已过期积分
        int expiredCount = pointMapper.markExpiredPoints(LocalDate.now());
        log.info("已清理过期积分记录: {}条", expiredCount);
    }
}
```

#### 5.4.4 会员等级体系

```sql
-- 会员等级配置表
CREATE TABLE `member_level_config` (
  `level` tinyint NOT NULL COMMENT '会员等级',
  `level_name` varchar(50) NOT NULL COMMENT '等级名称',
  `growth_threshold` int NOT NULL COMMENT '成长值门槛',
  `discount_rate` decimal(3,2) COMMENT '折扣率',
  `point_multiplier` decimal(3,2) NOT NULL DEFAULT 1.00 COMMENT '积分倍数',
  `free_shipping` tinyint NOT NULL DEFAULT 0 COMMENT '免邮特权:0无1有',
  `priority_service` tinyint NOT NULL DEFAULT 0 COMMENT '优先服务:0无1有',
  `birthday_gift` tinyint NOT NULL DEFAULT 0 COMMENT '生日礼物:0无1有',
  `status` tinyint NOT NULL DEFAULT 1 COMMENT '状态:1启用0禁用',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  PRIMARY KEY (`level`)
) COMMENT='会员等级配置表';

-- 示例数据
INSERT INTO `member_level_config` VALUES
(1, '普通会员', 0, 1.00, 1.00, 0, 0, 0, 1, NOW()),
(2, '白银会员', 1000, 0.95, 1.10, 0, 0, 1, 1, NOW()),
(3, '黄金会员', 5000, 0.90, 1.20, 1, 0, 1, 1, NOW()),
(4, '钻石会员', 20000, 0.85, 1.50, 1, 1, 1, 1, NOW());
```

### 5.5 活动参与业务流程

#### 5.5.1 打卡活动参与流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant A as 活动服务
    participant L as 位置服务
    participant M as 消息服务

    U->>F: 浏览活动列表
    F->>G: GET /api/activities
    G->>A: 查询活动列表
    A-->>F: 返回活动列表

    U->>F: 选择打卡活动，点击参与
    F->>G: POST /api/activities/{id}/participate
    G->>A: 参与活动
    A-->>F: 返回参与成功，展示打卡点

    loop 每个打卡点
        U->>F: 前往打卡点
        F->>L: 获取当前位置
        L-->>F: 返回位置信息

        alt 自动打卡（位置范围内）
            F->>G: POST /api/activities/checkpoint/check
            G->>A: 验证打卡条件
            A->>L: 验证位置
            L-->>A: 位置验证结果
            A-->>F: 打卡成功
            A->>M: 发送积分奖励
            M-->>U: 收到积分奖励通知
        else 手动打卡（需上传凭证）
            U->>F: 上传打卡凭证（图片/文字）
            F->>G: POST /api/activities/checkpoint/manual
            G->>A: 提交手动打卡
            A-->>F: 提交成功，待审核
            A->>M: 通知商户审核
        end
    end

    U->>F: 完成所有打卡点
    F->>G: POST /api/activities/{id}/complete
    G->>A: 申请完成活动
    A-->>F: 完成成功，发放终极奖励
    A->>M: 发送活动完成通知
    M-->>U: 收到终极奖励通知
```

#### 5.5.2 活动审核流程

```mermaid
graph TD
    A[商户创建活动] --> B[提交平台审核]
    B --> C{审核类型}
    C --> D[自动审核]
    C --> E[人工审核]

    D --> F{是否符合规则}
    F -->|是| G[审核通过]
    F -->|否| H[审核拒绝]

    E --> I[分配审核员]
    I --> J[审核员审核]
    J --> K{审核结果}
    K -->|通过| G
    K -->|拒绝| H
    K -->|需修改| L[退回修改]

    G --> M[活动上线]
    H --> N[通知商户]
    L --> O[商户修改后重新提交]
    O --> B

    M --> P[用户可参与]
    N --> Q[结束流程]
```

#### 5.5.3 活动异常处理（表 T-5.5.3）

| 异常场景             | 处理方案         | 用户通知                         | 商户通知                     | 系统处理             |
| -------------------- | ---------------- | -------------------------------- | ---------------------------- | -------------------- |
| **活动参与人数已满** | 停止接受新参与者 | "活动名额已满，敬请关注下次活动" | "活动参与人数已达上限"       | 更新活动状态为已满员 |
| **活动时间冲突**     | 不允许重复参与   | "您已参与同时间段的其他活动"     | -                            | 校验用户活动时间表   |
| **参与条件不满足**   | 拒绝参与申请     | "不满足参与条件，请查看活动要求" | -                            | 校验用户资格         |
| **打卡位置异常**     | 需要人工审核     | "打卡位置异常，等待审核"         | "有异常打卡需要审核"         | 标记为异常，通知审核 |
| **活动临时取消**     | 全额退款并补偿   | "活动因故取消，已为您办理退款"   | "活动已取消，请处理后续事宜" | 自动退款，发送补偿   |
| **奖励发放失败**     | 重试机制         | "奖励发放中，请稍后查看"         | "奖励发放异常，请检查"       | 记录失败，定时重试   |

---

我将继续补充完善长治文旅大生态服务平台产品需求说明书的剩余章节，基于务实渐进式架构设计方案。

# 长治文旅大生态服务平台产品需求说明书（续）

## 6. 性能与 SLA 指标（P1 优先级）

### 6.1 系统性能指标（表 T-6.1）

| 指标类别       | 指标项           | 目标值   | 测量方法        | 告警阈值 | 优先级 |
| -------------- | ---------------- | -------- | --------------- | -------- | ------ |
| **页面性能**   | 首页加载时间     | ≤2 秒    | Lighthouse 测试 | >3 秒    | P0     |
|                | 列表页加载时间   | ≤1.5 秒  | 首屏渲染时间    | >2 秒    | P0     |
|                | 详情页加载时间   | ≤2 秒    | 完全加载时间    | >3 秒    | P1     |
| **API 性能**   | 接口平均响应时间 | ≤200ms   | 应用性能监控    | >500ms   | P0     |
|                | P95 响应时间     | ≤500ms   | 日志分析        | >800ms   | P0     |
|                | P99 响应时间     | ≤1 秒    | 性能监控        | >2 秒    | P1     |
| **数据库性能** | MySQL 查询响应   | ≤50ms    | 慢查询监控      | >100ms   | P0     |
|                | Redis 响应时间   | ≤10ms    | Redis 监控      | >20ms    | P0     |
|                | 连接池使用率     | ≤70%     | 数据库监控      | >85%     | P1     |
| **系统资源**   | CPU 使用率       | ≤60%     | 服务器监控      | >80%     | P1     |
|                | 内存使用率       | ≤70%     | 服务器监控      | >85%     | P1     |
|                | 磁盘 IOPS        | ≤80%     | 存储监控        | >90%     | P2     |
| **业务指标**   | 支付成功率       | ≥99.5%   | 支付回调统计    | <99%     | P0     |
|                | 核销成功率       | ≥99.8%   | 核销日志统计    | <99%     | P0     |
|                | 退款处理时效     | ≤24 小时 | 退款完成时间    | >48 小时 | P1     |
| **容量指标**   | 最大并发用户     | 5000     | 压力测试        | 4000     | P0     |
|                | 最大 TPS         | 1000     | 性能测试        | 800      | P0     |
|                | 数据存储容量     | 3 年数据 | 容量规划        | 剩余 10% | P1     |

### 6.2 数据量预估（表 T-6.2）

| 数据实体     | 每月新增 | 年增长率 | 存储大小（年） | 访问频率 | 保留策略           |
| ------------ | -------- | -------- | -------------- | -------- | ------------------ |
| **用户数据** | 50,000   | 30%      | 500MB          | 高频     | 永久保留           |
| **订单数据** | 100,000  | 50%      | 5GB            | 高频     | 3 年在线，5 年归档 |
| **支付记录** | 120,000  | 50%      | 2GB            | 中频     | 5 年               |
| **商品数据** | 5,000    | 20%      | 200MB          | 高频     | 永久               |
| **景区数据** | 100      | 10%      | 100MB          | 中频     | 永久               |
| **活动数据** | 500      | 40%      | 1GB            | 中频     | 3 年               |
| **日志数据** | 1 千万条 | 60%      | 50GB           | 低频     | 6 个月             |
| **图片文件** | 10,000   | 40%      | 100GB          | 中频     | 永久               |
| **核销记录** | 200,000  | 50%      | 2GB            | 中频     | 3 年               |
| **积分流水** | 300,000  | 60%      | 1GB            | 低频     | 2 年               |

**存储总量预估（3 年）：**

- 结构化数据：约 100GB
- 非结构化数据（图片/视频）：约 1TB
- 日志数据：约 150GB
- **总计：约 1.25TB**

### 6.3 SLA 服务级别协议

#### 6.3.1 服务可用性承诺

| 服务组件         | 可用性承诺 | RTO（恢复时间目标） | RPO（恢复点目标） | 影响范围 |
| ---------------- | ---------- | ------------------- | ----------------- | -------- |
| **整体平台**     | 99.95%     | 30 分钟             | 5 分钟            | 全平台   |
| **用户端小程序** | 99.90%     | 15 分钟             | 无数据丢失        | 游客使用 |
| **票务核心系统** | 99.99%     | 10 分钟             | 1 分钟            | 购票业务 |
| **支付系统**     | 99.99%     | 5 分钟              | 0                 | 资金交易 |
| **核销系统**     | 99.95%     | 20 分钟             | 1 分钟            | 入园消费 |
| **商户端**       | 99.90%     | 30 分钟             | 5 分钟            | 商户运营 |
| **管理后台**     | 99.90%     | 30 分钟             | 5 分钟            | 内部管理 |

#### 6.3.2 故障等级定义

| 故障等级    | 影响范围                         | 响应时间 | 恢复时间 | 上报级别            |
| ----------- | -------------------------------- | -------- | -------- | ------------------- |
| **P0-紧急** | 核心功能完全不可用，影响所有用户 | ≤5 分钟  | ≤30 分钟 | 技术总监+业务负责人 |
| **P1-严重** | 重要功能不可用，影响大量用户     | ≤15 分钟 | ≤2 小时  | 项目经理+运维负责人 |
| **P2-一般** | 非核心功能不可用，影响部分用户   | ≤30 分钟 | ≤4 小时  | 运维值班人员        |
| **P3-轻微** | 体验性问题，不影响使用           | ≤1 小时  | ≤8 小时  | 运维值班人员        |

#### 6.3.3 备份恢复策略

**数据备份策略：**

- **实时备份**：Redis 缓存数据实时同步到备节点
- **每日全量备份**：MySQL 每日凌晨 2 点全量备份，保留 7 天
- **每小时增量备份**：业务数据每小时增量备份，保留 24 小时
- **周度归档备份**：每周日进行归档备份，保留 1 个月
- **月度永久备份**：每月初进行永久备份，保留 1 年

**恢复演练计划：**

- 每月 1 次：数据库恢复演练
- 每季度 1 次：完整系统灾难恢复演练
- 每年 1 次：异地容灾演练

### 6.4 性能测试方案

#### 6.4.1 测试场景设计（表 T-6.4.1）

| 测试场景         | 并发用户数   | 持续时间 | 测试目标         | 通过标准             |
| ---------------- | ------------ | -------- | ---------------- | -------------------- |
| **基准测试**     | 100          | 30 分钟  | 建立性能基线     | 错误率<0.1%          |
| **负载测试**     | 500          | 1 小时   | 验证额定负载能力 | 响应时间<目标值 120% |
| **压力测试**     | 1000 → 2000  | 2 小时   | 发现系统瓶颈     | 系统不崩溃           |
| **稳定性测试**   | 300          | 24 小时  | 验证长时间稳定性 | 无内存泄漏           |
| **尖峰测试**     | 5000（瞬时） | 10 分钟  | 模拟节假日高峰   | 系统能正常恢复       |
| **容量测试**     | 逐步增加     | 4 小时   | 确定最大容量     | 找到性能拐点         |
| **故障恢复测试** | 300          | 1 小时   | 验证故障恢复能力 | 恢复时间<RTO         |

#### 6.4.2 测试环境配置

```yaml
# 性能测试环境配置
performance_test:
  # 测试服务器
  test_machine:
    cpu: 8核
    memory: 16GB
    network: 100Mbps

  # 压测工具
  stress_tools:
    - JMeter 5.5
    - LoadRunner 2020
    - Gatling

  # 监控工具
  monitoring:
    - Prometheus + Grafana
    - SkyWalking
    - ELK Stack

  # 测试数据
  test_data:
    total_users: 10000
    total_orders: 50000
    total_products: 1000

  # 测试场景
  scenarios:
    - name: "购票流程"
      steps:
        - 登录: 10%
        - 浏览票务: 30%
        - 下单支付: 40%
        - 查看订单: 20%

    - name: "核销流程"
      steps:
        - 商户登录: 10%
        - 扫码核销: 60%
        - 查看核销记录: 30%
```

#### 6.4.3 性能优化策略

**数据库优化：**

1. **索引优化**

   ```sql
   -- 关键索引设计
   ALTER TABLE `order` ADD INDEX `idx_user_status_time` (`user_id`, `order_status`, `create_time`);
   ALTER TABLE `product_sku` ADD INDEX `idx_merchant_stock` (`merchant_id`, `stock_available`);
   ALTER TABLE `ticket_verification` ADD INDEX `idx_code_time` (`verification_code`, `verification_time`);
   ```

2. **查询优化**

   ```sql
   -- 避免全表扫描
   SELECT * FROM order WHERE user_id = ? AND create_time >= ? LIMIT 20;

   -- 使用覆盖索引
   SELECT order_no, total_amount FROM order WHERE user_id = ?;

   -- 分页优化
   SELECT * FROM order WHERE id > ? ORDER BY id LIMIT 20;
   ```

3. **读写分离配置**
   ```
   主库：写操作 + 实时读
   从库1：报表查询 + 用户行为分析
   从库2：后台管理查询 + 数据导出
   ```

**缓存策略：**

```java
@Service
public class CacheService {
    // 1. 热点数据缓存
    @Cacheable(value = "scenic", key = "#scenicId", unless = "#result == null")
    public Scenic getScenicById(Long scenicId) {
        return scenicMapper.selectById(scenicId);
    }

    // 2. 防缓存穿透
    public Product getProductWithNullCache(Long productId) {
        String cacheKey = "product:" + productId;
        Product product = redisTemplate.get(cacheKey);

        if (product != null) {
            if (product.getId() == null) { // 缓存空值
                return null;
            }
            return product;
        }

        product = productMapper.selectById(productId);
        if (product == null) {
            // 缓存空值，防止缓存穿透
            redisTemplate.set(cacheKey, new Product(), 5, TimeUnit.MINUTES);
            return null;
        }

        redisTemplate.set(cacheKey, product, 30, TimeUnit.MINUTES);
        return product;
    }

    // 3. 防缓存击穿（分布式锁）
    public Ticket getTicketWithLock(Long ticketId) {
        String cacheKey = "ticket:" + ticketId;
        Ticket ticket = redisTemplate.get(cacheKey);

        if (ticket != null) {
            return ticket;
        }

        // 获取分布式锁
        String lockKey = "lock:ticket:" + ticketId;
        boolean locked = redisLock.tryLock(lockKey, 10, TimeUnit.SECONDS);

        try {
            if (locked) {
                // 双重检查
                ticket = redisTemplate.get(cacheKey);
                if (ticket != null) {
                    return ticket;
                }

                ticket = ticketMapper.selectById(ticketId);
                if (ticket != null) {
                    redisTemplate.set(cacheKey, ticket, 30, TimeUnit.MINUTES);
                }
            }
        } finally {
            if (locked) {
                redisLock.unlock(lockKey);
            }
        }

        return ticket;
    }
}
```

---

## 7. 异常处理与运营工具（P2 优先级）

### 7.1 异常场景处理方案

#### 7.1.1 技术异常处理（表 T-7.1.1）

| 异常类型           | 检测机制   | 自动处理      | 人工干预         | 监控告警      |
| ------------------ | ---------- | ------------- | ---------------- | ------------- |
| **数据库连接异常** | 连接池监控 | 自动重连 3 次 | 检查网络/DB 状态 | 连接失败率>5% |
| **Redis 异常**     | 哨兵监控   | 切换从节点    | 重启/修复主节点  | 连续失败 3 次 |
| **第三方接口超时** | 超时监控   | 降级/重试     | 联系服务商       | 失败率>10%    |
| **支付回调失败**   | 对账系统   | 定时补单      | 人工对账         | 补单失败>3 次 |
| **文件上传失败**   | 上传监控   | 重试 2 次     | 检查存储服务     | 失败率>5%     |
| **内存泄漏**       | JVM 监控   | 自动重启      | 代码分析修复     | 内存使用>90%  |
| **磁盘空间不足**   | 磁盘监控   | 清理日志      | 扩容存储         | 使用率>90%    |
| **网络攻击**       | WAF 监控   | 自动封禁 IP   | 安全分析         | 攻击频率阈值  |

#### 7.1.2 业务异常处理（表 T-7.1.2）

| 业务场景         | 常见异常             | 用户提示                             | 系统处理               | 补偿方案               |
| ---------------- | -------------------- | ------------------------------------ | ---------------------- | ---------------------- |
| **支付重复**     | 同一订单重复支付     | "检测到重复支付，多余款项将原路退回" | 识别重复支付记录       | 24 小时内自动退款      |
| **库存超卖**     | 库存不足时仍下单成功 | "库存异常，订单已取消，请联系客服"   | 库存校验失败，取消订单 | 退款+优惠券补偿        |
| **票价变化**     | 支付时票价已调整     | "票价已更新，请确认新价格"           | 重新计算金额，提示用户 | 按新价格支付或取消     |
| **核销失败**     | 二维码失效/重复核销  | "核销码无效，请联系工作人员"         | 记录异常原因           | 人工核销+问题排查      |
| **积分发放失败** | 支付成功未到账积分   | "积分发放异常，我们正在处理"         | 记录异常，定时任务补发 | 24 小时内补发积分      |
| **退款失败**     | 银行账户异常         | "退款失败，请联系客服处理"           | 标记退款失败状态       | 人工处理，其他方式退款 |
| **活动参与异常** | 名额已满但仍可报名   | "活动已满员，报名失败"               | 名额校验，拒绝报名     | 优先参与下次活动       |
| **配送异常**     | 收货地址无法配送     | "该地址暂不支持配送"                 | 下单时校验地址         | 建议修改地址或到店自提 |

#### 7.1.3 异常处理技术实现

```java
@Component
public class GlobalExceptionHandler {

    // 1. 业务异常处理
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public Result<Void> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }

    // 2. 参数校验异常
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseBody
    public Result<Void> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.joining(", "));
        return Result.error(ErrorCode.PARAM_ERROR.getCode(), message);
    }

    // 3. 系统异常处理
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result<Void> handleException(Exception e) {
        log.error("系统异常: ", e);

        // 根据异常类型返回不同错误码
        if (e instanceof TimeoutException) {
            return Result.error(ErrorCode.SERVICE_TIMEOUT);
        } else if (e instanceof ServiceUnavailableException) {
            return Result.error(ErrorCode.SERVICE_UNAVAILABLE);
        } else {
            return Result.error(ErrorCode.SYSTEM_ERROR);
        }
    }
}

// 重试机制实现
@Service
public class RetryService {

    @Retryable(value = {TimeoutException.class, NetworkException.class},
               maxAttempts = 3,
               backoff = @Backoff(delay = 1000, multiplier = 2))
    public PaymentResult callPaymentApi(PaymentRequest request) {
        // 调用支付接口
        return paymentClient.pay(request);
    }

    @Recover
    public PaymentResult recoverPayment(TimeoutException e, PaymentRequest request) {
        log.error("支付接口重试失败: {}", request.getOrderNo());
        // 标记订单为支付异常，需要人工处理
        orderService.markPaymentException(request.getOrderNo(), e.getMessage());
        return PaymentResult.fail("支付超时，请稍后查看订单状态");
    }
}

// 降级策略
@Service
public class FallbackService {

    @HystrixCommand(fallbackMethod = "getProductFallback")
    public Product getProductDetail(Long productId) {
        return productService.getDetail(productId);
    }

    public Product getProductFallback(Long productId) {
        // 返回基础信息，隐藏库存等敏感数据
        return Product.basicInfo(productId);
    }
}
```

### 7.2 运营工具设计

#### 7.2.1 数据分析看板

**核心指标看板：**

```sql
-- 运营核心指标查询
WITH daily_stats AS (
  SELECT
    DATE(create_time) AS stat_date,
    COUNT(DISTINCT user_id) AS dau,
    COUNT(DISTINCT order_no) AS order_count,
    SUM(pay_amount) AS gmv,
    SUM(CASE WHEN order_status = 2 THEN 1 ELSE 0 END) AS completed_orders,
    SUM(CASE WHEN order_status = 2 THEN pay_amount ELSE 0 END) AS completed_gmv
  FROM `order`
  WHERE create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  GROUP BY DATE(create_time)
)
SELECT
  stat_date,
  dau,
  order_count,
  gmv,
  completed_orders,
  completed_gmv,
  ROUND(order_count * 1.0 / dau, 2) AS per_user_orders,
  ROUND(gmv * 1.0 / dau, 2) AS arpu
FROM daily_stats
ORDER BY stat_date DESC;
```

**数据看板功能设计：**

1. **实时监控大屏**

   - 今日实时数据：订单数、GMV、用户数
   - 热销商品 TOP10
   - 景区热度排行
   - 异常订单监控

2. **业务分析看板**

   - 用户分析：新增用户、留存率、用户画像
   - 交易分析：转化漏斗、客单价、复购率
   - 商品分析：库存周转、销售排行、毛利率
   - 活动分析：参与率、转化效果、ROI

3. **预测分析模块**

   ```python
   # 销售预测模型示例
   def predict_sales(product_id, days_ahead=7):
       # 1. 获取历史数据
       history_data = get_sales_history(product_id, 90)

       # 2. 特征工程
       features = extract_features(history_data)

       # 3. 使用Prophet或LSTM进行预测
       model = Prophet()
       model.fit(history_data)

       # 4. 生成预测
       future = model.make_future_dataframe(periods=days_ahead)
       forecast = model.predict(future)

       return forecast.tail(days_ahead)
   ```

#### 7.2.2 运营活动配置工具

```yaml
# 活动配置模板
activity_template:
  basic_info:
    name: "春季踏青打卡活动"
    type: "checkpoint"
    time_range:
      start: "2025-03-01 00:00:00"
      end: "2025-03-31 23:59:59"

  participation_rules:
    user_type: "all" # all/vip/new_user
    requirement:
      - type: "min_order_amount"
        value: 100
      - type: "has_visited"
        scenic_ids: [1, 2, 3]

  checkpoint_config:
    checkpoints:
      - id: 1
        name: "太行山大峡谷"
        type: "location"
        required: true
        reward:
          points: 50
          coupon: "spring_10"

      - id: 2
        name: "分享美景"
        type: "social_share"
        required: false
        reward:
          points: 20

  final_reward:
    complete_all:
      points: 200
      coupon: "spring_50"
      badge: "踏青达人"
    complete_partial:
      points: 100

  promotion_channels:
    - type: "push_notification"
      schedule: "2025-02-28 10:00:00"
      target: "all_users"
    - type: "banner"
      position: "home_top"
      duration: 7

  budget_control:
    total_budget: 10000
    daily_limit: 500
    user_limit: 100
```

#### 7.2.3 内容管理系统（CMS）

**功能模块设计：**

1. **轮播图管理**

   - 支持多端不同配置
   - A/B 测试功能
   - 点击率统计

2. **文章资讯管理**

   - 富文本编辑器
   - 多图支持
   - SEO 优化

3. **公告通知管理**

   - 定时发布
   - 用户分组推送
   - 阅读统计

4. **推荐位管理**
   - 人工推荐
   - 算法推荐
   - 个性化配置

### 7.3 客服工单系统设计

#### 7.3.1 工单处理流程

```mermaid
stateDiagram-v2
    [*] --> 待处理
    待处理 --> 处理中: 客服接单
    处理中 --> 待用户反馈: 需要用户提供信息
    待用户反馈 --> 处理中: 用户回复
    处理中 --> 已解决: 问题解决
    已解决 --> [*]: 用户确认关闭
    已解决 --> 处理中: 用户不满意
    待处理 --> 已关闭: 自动关闭（超时）
    处理中 --> 已升级: 需要技术支持
    已升级 --> 处理中: 技术解决
```

#### 7.3.2 智能客服设计

**知识库结构：**

```json
{
  "categories": [
    {
      "name": "购票问题",
      "questions": [
        {
          "question": "如何购买门票？",
          "answer": "可以通过以下步骤购票...",
          "keywords": ["购票", "购买", "门票"],
          "related_questions": ["如何退票？", "如何改签？"]
        }
      ]
    }
  ],
  "escalation_rules": [
    {
      "condition": "question_contains_refund",
      "priority": "high",
      "assign_to": "finance_team"
    }
  ]
}
```

**客服机器人流程：**

```python
class CustomerServiceBot:
    def handle_user_query(self, user_message, user_context):
        # 1. 意图识别
        intent = self.classify_intent(user_message)

        # 2. 查询知识库
        if intent == "faq":
            answer = self.search_knowledge_base(user_message)
            return self.format_answer(answer)

        # 3. 业务查询
        elif intent == "order_query":
            if not user_context.get('order_no'):
                return self.ask_for_order_number()
            order_info = self.query_order(user_context['order_no'])
            return self.format_order_info(order_info)

        # 4. 转人工
        else:
            return self.transfer_to_human_agent()

    def escalate_ticket(self, ticket):
        # 根据规则升级工单
        if ticket.priority == 'urgent':
            ticket.assign_to = 'senior_agent'
        elif ticket.category == 'technical':
            ticket.assign_to = 'tech_support'

        return ticket
```

---

## 8. 用户体验与合规要求（P3 优先级）

### 8.1 多端体验设计规范

#### 8.1.1 设计系统规范

**颜色规范：**

```css
/* 主色调 - 长治文旅品牌色 */
:root {
  --primary-color: #2b6cb0; /* 主蓝 */
  --secondary-color: #38a169; /* 生态绿 */
  --accent-color: #d69e2e; /* 活力橙 */

  /* 中性色 */
  --text-primary: #2d3748;
  --text-secondary: #718096;
  --border-color: #e2e8f0;
  --background-color: #f7fafc;
}

/* 功能色 */
--success-color: #38a169;
--warning-color: #d69e2e;
--error-color: #e53e3e;
--info-color: #3182ce;
```

**字体规范：**

```css
/* 中文字体 */
--font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
  "WenQuanYi Micro Hei", sans-serif;

/* 字号规范 */
--font-size-xs: 12px; /* 辅助文字 */
--font-size-sm: 14px; /* 正文小 */
--font-size-base: 16px; /* 正文 */
--font-size-lg: 18px; /* 小标题 */
--font-size-xl: 20px; /* 大标题 */
```

**间距规范（8px 基准）：**

```css
--spacing-xs: 4px; /* 紧凑间距 */
--spacing-sm: 8px; /* 基础间距 */
--spacing-md: 16px; /* 组件间距 */
--spacing-lg: 24px; /* 区块间距 */
--spacing-xl: 32px; /* 大间距 */
```

#### 8.1.2 响应式设计规范

**断点设计：**

```css
/* 移动端优先 */
.container {
  padding: var(--spacing-md);
}

/* 平板 */
@media (min-width: 768px) {
  .container {
    padding: var(--spacing-lg);
    max-width: 720px;
    margin: 0 auto;
  }
}

/* 桌面端 */
@media (min-width: 1024px) {
  .container {
    max-width: 960px;
  }
}

/* 大桌面 */
@media (min-width: 1280px) {
  .container {
    max-width: 1200px;
  }
}
```

**组件适配规范：**

```vue
<!-- 响应式组件示例 -->
<template>
  <div class="product-card" :class="{ mobile: isMobile }">
    <img
      :src="product.image"
      :class="['product-image', sizeClass]"
      :alt="product.name"
    />
    <div class="product-info">
      <h3 class="product-name">{{ product.name }}</h3>
      <div class="product-price">
        <span class="current-price">¥{{ product.price }}</span>
        <span v-if="product.originalPrice" class="original-price"
          >¥{{ product.originalPrice }}</span
        >
      </div>
    </div>
  </div>
</template>

<script>
export default {
  computed: {
    isMobile() {
      return window.innerWidth < 768;
    },
    sizeClass() {
      if (this.isMobile) return "size-mobile";
      return "size-desktop";
    },
  },
};
</script>
```

#### 8.1.3 无障碍设计规范

**WCAG 2.1 AA 标准实现：**

1. **可感知性**

   ```html
   <!-- 图片替代文本 -->
   <img src="scenic-image.jpg" alt="太行山大峡谷全景照片，展现壮丽的山川景色" />

   <!-- 表单标签 -->
   <label for="username">用户名</label>
   <input type="text" id="username" aria-describedby="username-help" />
   <div id="username-help">请输入您的手机号或邮箱</div>

   <!-- 颜色对比度 -->
   <p class="text-primary">主要文字 - 对比度 ≥ 4.5:1</p>
   <button class="btn-primary">主要按钮 - 对比度 ≥ 3:1</button>
   ```

2. **可操作性**

   ```javascript
   // 键盘导航支持
   document.addEventListener("keydown", (e) => {
     if (e.key === "Tab") {
       // 确保焦点可见
       e.target.classList.add("focus-visible");
     }
   });

   // 焦点管理
   function trapFocus(element) {
     const focusableElements = element.querySelectorAll(
       'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
     );

     const firstFocusable = focusableElements[0];
     const lastFocusable = focusableElements[focusableElements.length - 1];

     element.addEventListener("keydown", (e) => {
       if (e.key === "Tab") {
         if (e.shiftKey && document.activeElement === firstFocusable) {
           e.preventDefault();
           lastFocusable.focus();
         } else if (!e.shiftKey && document.activeElement === lastFocusable) {
           e.preventDefault();
           firstFocusable.focus();
         }
       }
     });
   }
   ```

3. **可理解性**

   ```html
   <!-- 清晰的语言和结构 -->
   <main>
     <h1>长治文旅平台</h1>
     <nav aria-label="主导航">
       <ul>
         <li><a href="/" aria-current="page">首页</a></li>
         <li><a href="/tickets">景区门票</a></li>
       </ul>
     </nav>

     <!-- 错误提示 -->
     <div role="alert" class="error-message">请输入有效的手机号码</div>
   </main>
   ```

4. **健壮性**

   ```html
   <!-- 语义化HTML -->
   <article class="scenic-card">
     <header>
       <h2>{{ scenic.name }}</h2>
       <span class="scenic-level">{{ scenic.level }}</span>
     </header>

     <section>
       <h3>景区介绍</h3>
       <p>{{ scenic.description }}</p>
     </section>

     <footer>
       <button onclick="bookTicket()">立即预订</button>
     </footer>
   </article>
   ```

### 8.2 合规与安全要求

#### 8.2.1 数据安全合规

**个人信息保护（PIPL 合规）：**

```java
// 数据脱敏处理
@Component
public class DataMaskingService {

    private static final String MASK_CHAR = "*";

    // 手机号脱敏
    public String maskPhone(String phone) {
        if (StringUtils.isBlank(phone) || phone.length() < 7) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }

    // 身份证脱敏
    public String maskIdCard(String idCard) {
        if (StringUtils.isBlank(idCard) || idCard.length() < 15) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }

    // 银行卡脱敏
    public String maskBankCard(String bankCard) {
        if (StringUtils.isBlank(bankCard) || bankCard.length() < 4) {
            return bankCard;
        }
        return "**** **** **** " + bankCard.substring(bankCard.length() - 4);
    }
}

// 数据加密存储
@Component
public class DataEncryptionService {

    @Autowired
    private StringEncryptor encryptor;

    public String encrypt(String plainText) {
        return encryptor.encrypt(plainText);
    }

    public String decrypt(String encryptedText) {
        try {
            return encryptor.decrypt(encryptedText);
        } catch (Exception e) {
            log.error("数据解密失败", e);
            return null;
        }
    }
}
```

**数据访问控制：**

```sql
-- 数据库权限控制
-- 应用账号 - 只读权限
CREATE USER 'app_readonly'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON cct_hub.* TO 'app_readonly'@'%';

-- 应用账号 - 读写权限（特定表）
CREATE USER 'app_rw'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE ON cct_hub.order TO 'app_rw'@'%';
GRANT SELECT, INSERT, UPDATE ON cct_hub.user TO 'app_rw'@'%';

-- 备份账号 - 只读权限
CREATE USER 'backup'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, RELOAD, LOCK TABLES ON cct_hub.* TO 'backup'@'localhost';
```

#### 8.2.2 支付安全合规

**PCI DSS 合规要求：**

```java
@Component
public class PaymentSecurityService {

    // 1. 敏感数据不落地
    public PaymentToken tokenizeCardInfo(CardInfo cardInfo) {
        // 调用支付网关tokenization服务
        PaymentToken token = paymentGateway.tokenize(cardInfo);

        // 本地不存储完整的卡信息
        return token;
    }

    // 2. 支付请求签名
    public String signPaymentRequest(PaymentRequest request) {
        String data = request.getOrderNo() +
                     request.getAmount().toString() +
                     request.getTimestamp();

        return hmacSHA256(data, paymentSecretKey);
    }

    // 3. 防重放攻击
    public boolean validateNonce(String nonce) {
        // 检查nonce是否已使用过
        String key = "payment:nonce:" + nonce;
        return !redisTemplate.hasKey(key);
    }

    // 4. 金额一致性校验
    public boolean validateAmountConsistency(Order order, PaymentRequest request) {
        // 比较订单金额和支付金额
        BigDecimal orderAmount = order.getPayAmount();
        BigDecimal paymentAmount = request.getAmount();

        return orderAmount.compareTo(paymentAmount) == 0;
    }
}
```

#### 8.2.3 网络安全防护

**WAF 规则配置：**

```yaml
# Web应用防火墙规则
waf_rules:
  sql_injection:
    enabled: true
    action: block
    sensitivity: high

  xss_protection:
    enabled: true
    action: block
    sensitivity: medium

  rate_limiting:
    enabled: true
    limits:
      - path: "/api/payments/*"
        limit: 10 # 10次/分钟
        period: 60 # 60秒

      - path: "/api/users/login"
        limit: 5 # 5次/分钟
        period: 60 # 60秒

  bot_protection:
    enabled: true
    bot_types:
      - "bad_bot"
      - "scraper"
      - "spammer"

  ddos_protection:
    enabled: true
    thresholds:
      requests_per_second: 1000
      connections_per_ip: 100
```

**API 安全防护：**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            // 1. CSRF防护
            .csrf().disable()  // API服务通常禁用CSRF

            // 2. CORS配置
            .cors().configurationSource(corsConfigurationSource())

            // 3. 会话管理
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)

            // 4. 认证配置
            .and()
            .authorizeRequests()
                // 公开接口
                .antMatchers("/api/public/**").permitAll()
                .antMatchers("/api/users/login").permitAll()
                .antMatchers("/api/users/register").permitAll()

                // 需要认证的接口
                .antMatchers("/api/users/**").authenticated()
                .antMatchers("/api/orders/**").authenticated()
                .antMatchers("/api/payments/**").authenticated()

                // 管理接口需要管理员权限
                .antMatchers("/api/admin/**").hasRole("ADMIN")

            // 5. JWT过滤器
            .and()
            .addFilterBefore(jwtAuthenticationFilter,
                            UsernamePasswordAuthenticationFilter.class)

            // 6. 异常处理
            .exceptionHandling()
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
                .accessDeniedHandler(accessDeniedHandler);
    }
}
```

### 8.3 无障碍设计规范

#### 8.3.1 屏幕阅读器优化

**ARIA 标签使用：**

```html
<!-- 导航区域 -->
<nav aria-label="主菜单">
  <ul role="menubar">
    <li role="none">
      <a href="/" role="menuitem" aria-current="page">首页</a>
    </li>
    <li role="none">
      <a href="/tickets" role="menuitem">景区门票</a>
    </li>
  </ul>
</nav>

<!-- 表单区域 -->
<form aria-label="登录表单">
  <div role="group" aria-labelledby="username-label">
    <label id="username-label" for="username">用户名</label>
    <input
      type="text"
      id="username"
      aria-required="true"
      aria-describedby="username-error"
    />
    <div id="username-error" role="alert" aria-live="assertive">
      请输入有效的用户名
    </div>
  </div>
</form>

<!-- 加载状态 -->
<div role="status" aria-live="polite" aria-busy="true">
  正在加载数据，请稍候...
</div>

<!-- 模态框 -->
<div role="dialog" aria-modal="true" aria-labelledby="dialog-title">
  <h2 id="dialog-title">确认订单</h2>
  <!-- 内容 -->
  <button aria-label="关闭对话框">×</button>
</div>
```

#### 8.3.2 键盘操作支持

**焦点管理：**

```javascript
class AccessibilityManager {
  constructor() {
    this.initKeyboardNavigation();
    this.initSkipLinks();
    this.initFocusTraps();
  }

  // 1. 初始化键盘导航
  initKeyboardNavigation() {
    document.addEventListener("keydown", (e) => {
      // Tab键导航
      if (e.key === "Tab") {
        this.handleTabNavigation(e);
      }

      // 回车键激活
      if (e.key === "Enter" && e.target.getAttribute("role") === "button") {
        e.target.click();
      }

      // 空格键激活
      if (e.key === " " && e.target.getAttribute("role") === "button") {
        e.preventDefault();
        e.target.click();
      }

      // ESC键关闭
      if (e.key === "Escape") {
        this.closeModals();
      }
    });
  }

  // 2. 跳过链接（Skip Links）
  initSkipLinks() {
    const skipLinks = document.querySelectorAll("[data-skip-to]");

    skipLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("data-skip-to");
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          targetElement.setAttribute("tabindex", "-1");
          targetElement.focus();

          // 移除tabindex属性
          setTimeout(() => {
            targetElement.removeAttribute("tabindex");
          }, 100);
        }
      });
    });
  }

  // 3. 焦点陷阱（Focus Trap）
  initFocusTraps() {
    const modals = document.querySelectorAll('[role="dialog"]');

    modals.forEach((modal) => {
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );

      if (focusableElements.length > 0) {
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        modal.addEventListener("keydown", (e) => {
          if (e.key === "Tab") {
            if (e.shiftKey && document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        });
      }
    });
  }

  // 4. 处理Tab导航
  handleTabNavigation(event) {
    // 确保焦点可见
    if (document.activeElement) {
      document.activeElement.classList.add("focus-visible");
    }

    // 移除之前的焦点样式
    const previousFocused = document.querySelector(".focus-visible");
    if (previousFocused && previousFocused !== document.activeElement) {
      previousFocused.classList.remove("focus-visible");
    }
  }
}
```

#### 8.3.3 高对比度模式支持

**CSS 变量实现主题切换：**

```css
/* 默认主题 */
:root {
  --text-color: #2d3748;
  --background-color: #ffffff;
  --primary-color: #2b6cb0;
  --border-color: #e2e8f0;
}

/* 高对比度主题 */
[data-theme="high-contrast"] {
  --text-color: #000000;
  --background-color: #ffffff;
  --primary-color: #0000ff;
  --border-color: #000000;
}

/* 深色模式 */
[data-theme="dark"] {
  --text-color: #e2e8f0;
  --background-color: #1a202c;
  --primary-color: #63b3ed;
  --border-color: #4a5568;
}

/* 应用主题 */
body {
  color: var(--text-color);
  background-color: var(--background-color);
}

button {
  background-color: var(--primary-color);
  border: 2px solid var(--border-color);
}

/* 焦点样式 */
.focus-visible {
  outline: 3px solid var(--primary-color);
  outline-offset: 2px;
}

/* 减少动画 */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
```

**主题切换功能：**

```javascript
class ThemeManager {
  constructor() {
    this.initThemeSwitcher();
    this.detectSystemPreferences();
  }

  initThemeSwitcher() {
    const switcher = document.getElementById("theme-switcher");
    if (!switcher) return;

    // 从本地存储读取主题
    const savedTheme = localStorage.getItem("theme") || "default";
    this.setTheme(savedTheme);

    // 切换主题
    switcher.addEventListener("change", (e) => {
      const theme = e.target.value;
      this.setTheme(theme);
      localStorage.setItem("theme", theme);
    });
  }

  detectSystemPreferences() {
    // 检测系统主题偏好
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
    const prefersContrast = window.matchMedia("(prefers-contrast: more)");
    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    );

    // 监听系统主题变化
    prefersDark.addEventListener("change", (e) => {
      if (!localStorage.getItem("theme")) {
        this.setTheme(e.matches ? "dark" : "default");
      }
    });

    // 应用减少动画偏好
    if (prefersReducedMotion.matches) {
      document.documentElement.setAttribute("data-reduced-motion", "true");
    }
  }

  setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);

    // 发送主题变更事件
    const event = new CustomEvent("themechange", { detail: { theme } });
    document.dispatchEvent(event);
  }
}
```

---

## 9. API 设计规范与接口文档

### 9.1 RESTful API 设计规范

#### 9.1.1 通用约定

**1. 基础 URL：**

```
https://api.cct-hub.changzhi.gov.cn/v1/
```

**2. 请求格式：**

```http
# 标准请求头
GET /api/users/{id} HTTP/1.1
Host: api.cct-hub.changzhi.gov.cn
Accept: application/json
Authorization: Bearer {token}
X-Request-ID: {uuid}
X-Client-Version: 1.0.0
```

**3. 响应格式：**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 业务数据
  },
  "timestamp": 1733760000,
  "requestId": "req_1234567890"
}
```

**4. 分页格式：**

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      // 数据列表
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 100,
      "pages": 5
    }
  }
}
```

#### 9.1.2 接口设计规范

```java
// 统一响应体
@Data
public class ApiResponse<T> {
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    private String requestId;

    public static <T> ApiResponse<T> success(T data) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setCode(0);
        response.setMessage("success");
        response.setData(data);
        response.setTimestamp(System.currentTimeMillis());
        response.setRequestId(RequestIdHolder.get());
        return response;
    }
}

// 分页请求参数
@Data
public class PageRequest {
    @Min(1)
    private Integer page = 1;

    @Min(1)
    @Max(100)
    private Integer size = 20;

    private String sortBy;
    private SortDirection sortDirection = SortDirection.DESC;
}

// 错误码定义
public enum ErrorCode {
    SUCCESS(0, "成功"),

    // 通用错误 1000-1999
    PARAM_ERROR(1001, "参数错误"),
    DATA_NOT_FOUND(1002, "数据不存在"),
    PERMISSION_DENIED(1003, "权限不足"),

    // 业务错误 2000-2999
    ORDER_NOT_FOUND(2001, "订单不存在"),
    ORDER_STATUS_ERROR(2002, "订单状态错误"),
    INVENTORY_NOT_ENOUGH(2003, "库存不足"),

    // 系统错误 5000-5999
    SYSTEM_ERROR(5000, "系统错误"),
    SERVICE_UNAVAILABLE(5001, "服务暂时不可用"),

    // 第三方错误 6000-6999
    PAYMENT_FAILED(6001, "支付失败");

    private final Integer code;
    private final String message;

    // 构造函数、getter省略
}
```

### 9.2 核心接口文档示例

#### 9.2.1 用户模块接口

**1. 用户注册接口**

```http
POST /api/v1/users/register
Content-Type: application/json

请求体：
{
  "phone": "13800138000",
  "smsCode": "123456",
  "password": "password123",
  "inviteCode": "INVITE123"  // 可选
}

响应：
{
  "code": 0,
  "message": "success",
  "data": {
    "userId": 12345,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expireTime": 1733846400
  }
}
```

**2. 用户登录接口**

```http
POST /api/v1/users/login
Content-Type: application/json

请求体：
{
  "loginType": "phone",  // phone/password/wechat
  "phone": "13800138000",
  "password": "password123",
  // 或
  "smsCode": "123456"
}

响应：
{
  "code": 0,
  "message": "success",
  "data": {
    "userId": 12345,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "nickname": "旅行家",
      "avatar": "https://...",
      "memberLevel": 2,
      "points": 1000
    }
  }
}
```

#### 9.2.2 票务模块接口

**1. 查询可用票务**

```http
GET /api/v1/tickets/available
Query Parameters:
  scenicId: 1
  date: 2025-12-25
  ticketType: 1  // 1-单票 2-联票 3-套票
  page: 1
  size: 20

响应：
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "ticketId": 1,
        "ticketName": "太行山大峡谷成人票",
        "scenicName": "太行山大峡谷",
        "date": "2025-12-25",
        "price": {
          "original": 120.00,
          "current": 100.00,
          "discount": 20.00
        },
        "inventory": {
          "total": 1000,
          "available": 500,
          "status": "available"  // available/low/sold_out
        },
        "tags": ["热销", "推荐"],
        "validity": {
          "startDate": "2025-12-25",
          "endDate": "2025-12-25",
          "entryTime": "08:00-16:00"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 50,
      "pages": 3
    }
  }
}
```

**2. 创建门票订单**

```http
POST /api/v1/orders/ticket
Content-Type: application/json
Authorization: Bearer {token}

请求体：
{
  "ticketId": 1,
  "date": "2025-12-25",
  "visitors": [
    {
      "name": "张三",
      "idCard": "142401199001011234",
      "phone": "13800138000",
      "type": "adult"  // adult/child/student/elderly
    }
  ],
  "couponCode": "SAVE10",
  "usePoints": 100
}

响应：
{
  "code": 0,
  "message": "success",
  "data": {
    "orderNo": "ORDER202512250001",
    "totalAmount": 90.00,
    "payAmount": 89.00,
    "items": [
      {
        "ticketName": "太行山大峡谷成人票",
        "price": 100.00,
        "visitorName": "张三"
      }
    ],
    "paymentInfo": {
      "orderNo": "ORDER202512250001",
      "payAmount": 89.00,
      "expireTime": "2025-12-25 23:59:59"
    }
  }
}
```

#### 9.2.3 支付模块接口

**1. 发起支付**

```http
POST /api/v1/payments/create
Content-Type: application/json
Authorization: Bearer {token}

请求体：
{
  "orderNo": "ORDER202512250001",
  "paymentMethod": "wechat",  // wechat/alipay/balance
  "channel": "miniprogram"    // miniprogram/app/web
}

响应：
{
  "code": 0,
  "message": "success",
  "data": {
    "paymentNo": "PAY202512250001",
    "orderNo": "ORDER202512250001",
    "payAmount": 89.00,
    "paymentParams": {
      // 微信支付参数
      "appId": "wx1234567890",
      "timeStamp": "1733760000",
      "nonceStr": "5K8264ILTKCH16CQ2502SI8ZNMTM67VS",
      "package": "prepay_id=wx201410272009395522657a690389285100",
      "signType": "RSA",
      "paySign": "oR9d8PuhnIc+YZ8cBHFCwfgpaK9gd7vaRvkYD7rthRAZ..."
    }
  }
}
```

### 9.3 接口安全规范

#### 9.3.1 认证与授权

```java
// JWT认证过滤器
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtTokenProvider tokenProvider;

    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        try {
            String jwt = getJwtFromRequest(request);

            if (StringUtils.hasText(jwt) && tokenProvider.validateToken(jwt)) {
                String userId = tokenProvider.getUserIdFromJWT(jwt);

                UserDetails userDetails = userDetailsService.loadUserByUsername(userId);
                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());

                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception ex) {
            logger.error("Could not set user authentication in security context", ex);
        }

        filterChain.doFilter(request, response);
    }

    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}

// 权限注解
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasRole('ADMIN') or @permissionService.hasPermission(#id)")
public @interface ResourcePermission {
    String value() default "";
}

// 使用示例
@RestController
@RequestMapping("/api/orders")
public class OrderController {

    @GetMapping("/{orderNo}")
    @ResourcePermission("order:read")
    public ApiResponse<Order> getOrder(@PathVariable String orderNo) {
        // 只有订单所属用户或管理员可以访问
        return ApiResponse.success(orderService.getOrder(orderNo));
    }
}
```

#### 9.3.2 参数校验与防攻击

```java
// 参数校验
@Validated
@RestController
@RequestMapping("/api/users")
public class UserController {

    @PostMapping("/update")
    public ApiResponse<Void> updateUser(
            @Valid @RequestBody UserUpdateRequest request,
            BindingResult bindingResult) {

        if (bindingResult.hasErrors()) {
            throw new ValidationException(bindingResult);
        }

        // 业务逻辑
        return ApiResponse.success();
    }
}

// 防XSS攻击
@Component
public class XssFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        XssHttpServletRequestWrapper xssRequest = new XssHttpServletRequestWrapper((HttpServletRequest) request);
        chain.doFilter(xssRequest, response);
    }
}

// XSS请求包装器
public class XssHttpServletRequestWrapper extends HttpServletRequestWrapper {

    public XssHttpServletRequestWrapper(HttpServletRequest request) {
        super(request);
    }

    @Override
    public String getParameter(String name) {
        String value = super.getParameter(name);
        return cleanXSS(value);
    }

    @Override
    public String[] getParameterValues(String name) {
        String[] values = super.getParameterValues(name);
        if (values == null) {
            return null;
        }

        String[] cleanedValues = new String[values.length];
        for (int i = 0; i < values.length; i++) {
            cleanedValues[i] = cleanXSS(values[i]);
        }
        return cleanedValues;
    }

    private String cleanXSS(String value) {
        if (value == null) {
            return null;
        }

        // 使用ESAPI进行XSS清理
        return ESAPI.encoder().canonicalize(value);
    }
}

// 防SQL注入
@Repository
public class SafeUserRepository {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 使用预编译语句
    public User findByPhone(String phone) {
        String sql = "SELECT * FROM user WHERE phone = ? AND status = 1";
        return jdbcTemplate.queryForObject(sql, new Object[]{phone}, User.class);
    }

    // 使用命名参数
    public List<User> searchUsers(String keyword) {
        String sql = "SELECT * FROM user WHERE nickname LIKE :keyword";
        MapSqlParameterSource params = new MapSqlParameterSource();
        params.addValue("keyword", "%" + keyword + "%");

        return namedParameterJdbcTemplate.query(sql, params, User.class);
    }
}
```

#### 9.3.3 限流与熔断

```java
// 限流配置
@Configuration
public class RateLimitConfig {

    @Bean
    public UserKeyResolver userKeyResolver() {
        return exchange -> {
            String token = exchange.getRequest().getHeaders().getFirst("Authorization");
            if (StringUtils.isEmpty(token)) {
                return Mono.just(exchange.getRequest().getRemoteAddress().getAddress().getHostAddress());
            }
            return Mono.just(token);
        };
    }

    @Bean
    public RedisRateLimiter redisRateLimiter() {
        return new RedisRateLimiter(10, 20); // 10个请求/秒，20个令牌
    }
}

// 路由限流配置
@Configuration
public class RouteConfig {

    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("user_api", r -> r
                .path("/api/users/**")
                .filters(f -> f
                    .requestRateLimiter(config -> config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(userKeyResolver()))
                    .circuitBreaker(config -> config
                        .setName("userService")
                        .setFallbackUri("forward:/fallback/user")))
                .uri("lb://user-service"))
            .build();
    }
}

// 熔断降级
@Component
public class PaymentFallback implements FallbackProvider {

    @Override
    public String getRoute() {
        return "payment-service";
    }

    @Override
    public ClientHttpResponse fallbackResponse(String route, Throwable cause) {
        return new ClientHttpResponse() {
            @Override
            public HttpStatus getStatusCode() throws IOException {
                return HttpStatus.OK;
            }

            @Override
            public int getRawStatusCode() throws IOException {
                return HttpStatus.OK.value();
            }

            @Override
            public String getStatusText() throws IOException {
                return "OK";
            }

            @Override
            public void close() {
            }

            @Override
            public InputStream getBody() throws IOException {
                String response = "{\"code\":5001,\"message\":\"支付服务暂时不可用，请稍后重试\"}";
                return new ByteArrayInputStream(response.getBytes());
            }

            @Override
            public HttpHeaders getHeaders() {
                HttpHeaders headers = new HttpHeaders();
                headers.setContentType(MediaType.APPLICATION_JSON);
                return headers;
            }
        };
    }
}
```

---

## 10. 项目里程碑与实施计划（基于新架构更新）

### 10.1 基于新架构的三阶段实施计划

#### 10.1.1 第一阶段：基础平台搭建（1-3 个月）

**目标**：完成核心购票-支付-核销闭环，验证商业模式

**关键交付物：**

1. **用户端小程序**：首页、票务查询、订单支付、个人中心
2. **商户端小程序**：商户入驻、商品管理、核销功能
3. **PC 管理端**：基础管理功能
4. **核心业务服务**：用户、票务、订单、支付模块

**详细计划：**
| 周次 | 开发重点 | 测试重点 | 上线内容 |
|------|---------|---------|---------|
| 1-2 | 项目初始化、技术栈搭建、数据库设计 | 环境部署、CI/CD 流程 | 开发环境搭建 |
| 3-4 | 用户端首页、票务列表、详情页 | 页面兼容性、性能测试 | 小程序框架 |
| 5-6 | 用户注册登录、购票流程、订单创建 | 业务流程测试、压力测试 | 用户认证系统 |
| 7-8 | 支付集成、电子票生成、核销功能 | 支付安全测试、性能测试 | 购票支付闭环 |
| 9-10 | 商户端功能、PC 管理后台 | 商户流程测试、权限测试 | 商户入驻流程 |
| 11-12 | 系统联调、性能优化、安全加固 | 完整业务流程测试 | 第一阶段正式上线 |

**风险控制：**

- 技术风险：支付接口对接延迟 → 准备备用方案（线下核销）
- 业务风险：用户接受度低 → 准备运营推广活动
- 人员风险：核心人员流失 → 建立文档和代码规范

#### 10.1.2 第二阶段：功能完善与优化（4-6 个月）

**目标**：架构拆分为四服务，引入数据分析，完善功能

**关键交付物：**

1. **四服务架构**：核心业务、支付财务、运营商户、数据消息服务
2. **数据分析平台**：ClickHouse 集成，运营报表
3. **活动系统**：打卡活动、积分系统
4. **优化功能**：搜索、推荐、消息推送

**详细计划：**
| 里程碑 | 技术任务 | 业务目标 | 完成标志 |
|--------|---------|---------|---------|
| M2.1 | 服务拆分，引入消息队列 | 提升系统稳定性 | 四服务独立部署运行 |
| M2.2 | ClickHouse 集成，报表开发 | 实现数据驱动运营 | 运营看板上线 |
| M2.3 | 活动系统、积分系统开发 | 提升用户粘性 | 首场平台活动上线 |
| M2.4 | 搜索优化、个性化推荐 | 提升转化率 | 搜索功能优化上线 |
| M2.5 | 消息推送系统、监控完善 | 提升用户体验 | 用户活跃度提升 20% |

#### 10.1.3 第三阶段：智能化与生态扩展（7-12 个月）

**目标**：智能推荐、开放平台、生态扩展

**关键交付物：**

1. **智能推荐系统**：基于用户行为的个性化推荐
2. **开放平台**：API 开放，第三方接入
3. **供应链系统**：供应商管理，商品溯源
4. **多端扩展**：APP、公众号、自助机

### 10.2 新旧架构对比与迁移策略

#### 10.2.1 架构对比分析

| 对比维度       | 原架构（微服务集群） | 新架构（四服务渐进式） | 优势分析             |
| -------------- | -------------------- | ---------------------- | -------------------- |
| **服务数量**   | 13+个微服务          | 4 个核心服务           | 运维复杂度降低 70%   |
| **团队要求**   | 需要微服务专家       | 通用开发技能即可       | 降低招聘和培训成本   |
| **部署复杂度** | 需要完整的服务网格   | 简单部署，渐进演进     | 部署时间减少 50%     |
| **事务处理**   | 分布式事务复杂       | 大部分本地事务         | 开发效率提升 40%     |
| **故障排查**   | 链路追踪复杂         | 日志集中，易排查       | 故障定位时间减少 60% |
| **成本投入**   | 基础设施成本高       | 按需扩展，成本可控     | 初期成本降低 40%     |

#### 10.2.2 数据迁移策略

```sql
-- 迁移方案：双写过渡
-- 1. 新老系统并行运行
-- 2. 逐步迁移数据

-- 数据同步工具
CREATE PROCEDURE sync_user_data()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE user_id BIGINT;
    DECLARE cur CURSOR FOR
        SELECT id FROM old_user WHERE update_time > DATE_SUB(NOW(), INTERVAL 1 DAY);
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN cur;

    read_loop: LOOP
        FETCH cur INTO user_id;
        IF done THEN
            LEAVE read_loop;
        END IF;

        -- 同步用户数据
        INSERT INTO new_user (...)
        SELECT ... FROM old_user WHERE id = user_id
        ON DUPLICATE KEY UPDATE ...;

        -- 同步关联数据
        INSERT INTO new_user_wallet (...)
        SELECT ... FROM old_wallet WHERE user_id = user_id
        ON DUPLICATE KEY UPDATE ...;
    END LOOP;

    CLOSE cur;
END;

-- 定时任务配置
CREATE EVENT sync_data_event
ON SCHEDULE EVERY 5 MINUTE
DO
    CALL sync_user_data();
```

### 10.3 新架构下的风险控制计划

#### 10.3.1 技术风险控制

| 风险点               | 影响等级 | 预防措施               | 应急方案                 |
| -------------------- | -------- | ---------------------- | ------------------------ |
| **数据库性能瓶颈**   | 高       | 分库分表设计，读写分离 | 数据库垂直拆分，增加从库 |
| **第三方服务不稳定** | 中       | 多服务商备份，熔断降级 | 切换备用服务商           |
| **并发处理能力不足** | 高       | 压力测试，限流设置     | 降级服务，增加节点       |
| **数据一致性风险**   | 高       | 分布式事务，对账系统   | 人工对账，补偿机制       |
| **安全漏洞**         | 高       | 定期安全扫描，代码审计 | 紧急修复，数据备份       |

#### 10.3.2 业务风险控制

| 风险场景           | 发生概率 | 业务影响             | 应对策略               |
| ------------------ | -------- | -------------------- | ---------------------- |
| **节假日流量高峰** | 高       | 系统过载，用户体验差 | 提前容量评估，弹性扩容 |
| **商户合作中断**   | 中       | 商品供应中断         | 多商户合作，备用方案   |
| **政策变化影响**   | 低       | 业务模式调整         | 灵活架构，快速响应     |
| **用户数据泄露**   | 低       | 信任危机，法律风险   | 加密存储，访问控制     |
| **支付风险**       | 中       | 资金损失             | 风控系统，实时监控     |

---

## 11. 评审要点与验收标准（基于新架构更新）

### 11.1 新架构下的三方评审要点

#### 11.1.1 技术架构评审

**评审维度：**

1. **合理性**

   - 四服务划分是否符合业务边界？
   - 服务间通信是否必要且合理？
   - 数据库设计是否符合范式？

2. **可扩展性**

   - 是否支持水平扩展？
   - 未来如何进一步拆分服务？
   - 数据增长如何处理？

3. **可维护性**

   - 代码结构是否清晰？
   - 文档是否完整？
   - 部署是否简单？

4. **性能**
   - 是否有性能瓶颈？
   - 缓存策略是否合理？
   - 数据库索引是否优化？

**评审清单：**

- [ ] 架构图是否清晰展示四服务划分？
- [ ] 数据库设计文档是否完整？
- [ ] API 设计是否符合 RESTful 规范？
- [ ] 错误处理机制是否完善？
- [ ] 监控告警系统是否健全？

#### 11.1.2 业务逻辑评审

**评审要点：**

1. **购票流程**

   - 库存管理是否正确？
   - 退改签规则是否清晰？
   - 支付流程是否安全？

2. **积分系统**

   - 积分获取规则是否合理？
   - 积分消耗场景是否丰富？
   - 防刷机制是否有效？

3. **活动系统**
   - 活动规则是否灵活？
   - 参与流程是否顺畅？
   - 奖励发放是否准确？

### 11.2 新架构验收标准

#### 11.2.1 功能验收标准

**核心功能验收：**
| 功能模块 | 验收标准 | 测试用例 | 通过标准 |
|---------|---------|---------|---------|
| **用户注册登录** | 支持多种登录方式 | 20 个测试用例 | 成功率 ≥99.9% |
| **购票流程** | 完整购票-支付-核销流程 | 50 个测试用例 | 成功率 ≥99.5% |
| **退改签** | 按规则退票改签 | 30 个测试用例 | 准确率 100% |
| **积分系统** | 积分获取和消耗 | 40 个测试用例 | 数据准确率 100% |
| **活动参与** | 活动报名打卡 | 25 个测试用例 | 流程完整率 100% |

#### 11.2.2 性能验收标准

**性能指标验收：**

```yaml
性能验收标准:
  响应时间:
    首页加载: ≤2秒
    API平均响应: ≤200ms
    P95响应时间: ≤500ms

  并发能力:
    支持并发用户: 5000
    支持TPS: 1000
    支付成功率: ≥99.5%

  稳定性:
    系统可用性: ≥99.95%
    平均无故障时间: ≥720小时
    故障恢复时间: ≤30分钟
```

#### 11.2.3 安全验收标准

**安全测试项目：**

1. **渗透测试**

   - SQL 注入测试
   - XSS 跨站脚本测试
   - CSRF 跨站请求伪造测试
   - 文件上传漏洞测试

2. **安全扫描**

   - 代码安全扫描
   - 依赖组件漏洞扫描
   - 配置安全扫描

3. **合规检查**
   - 个人信息保护合规
   - 支付安全合规
   - 数据安全合规

### 11.3 架构演进验收标准

#### 11.3.1 第一阶段验收（模块化单体）

**验收标准：**

1. **功能完整**：核心购票流程可用
2. **性能达标**：支持 1000 并发用户
3. **部署成功**：可一键部署
4. **监控就绪**：基础监控报警

**验收清单：**

- [ ] 用户端小程序可正常使用
- [ ] 购票支付流程完整
- [ ] 商户端可管理商品
- [ ] 管理后台可查看数据
- [ ] 系统监控正常

#### 11.3.2 第二阶段验收（四服务架构）

**验收标准：**

1. **架构拆分**：成功拆分为四个服务
2. **独立部署**：各服务可独立部署扩展
3. **数据同步**：数据同步机制正常
4. **性能提升**：性能指标提升 30%

**验收清单：**

- [ ] 四服务独立运行
- [ ] 服务间通信正常
- [ ] 数据一致性保障
- [ ] 运营报表可用
- [ ] 活动系统上线

#### 11.3.3 第三阶段验收（智能扩展）

**验收标准：**

1. **智能推荐**：推荐系统上线
2. **开放平台**：API 开放文档
3. **生态扩展**：第三方接入
4. **数据驱动**：数据产品丰富

---

## 附录

### A. 参考资料

1. **技术标准**

   - RESTful API 设计规范
   - 微服务架构设计模式
   - 数据库设计范式
   - 网络安全标准

2. **行业规范**

   - 文旅行业数字化标准
   - 电子票务系统规范
   - 在线支付安全规范
   - 个人信息保护法

3. **最佳实践**
   - 阿里云架构设计白皮书
   - 腾讯云微服务实践
   - 高可用系统设计模式
   - 大数据处理最佳实践

### B. 变更记录（更新）

| 版本     | 日期           | 作者        | 变更内容                             | 状态       |
| -------- | -------------- | ----------- | ------------------------------------ | ---------- |
| v1.0     | 2025-12-09     | 产品团队    | 初始版本创建                         | 已发布     |
| v1.1     | 2025-12-10     | AI 助手     | 补充架构设计、数据模型、业务流程     | 已发布     |
| **v1.2** | **2025-12-10** | **AI 助手** | **重构为务实渐进式架构，四服务模型** | **待评审** |
|          |                |             | - 调整技术架构为四服务精简模型       |            |
|          |                |             | - 优化技术栈选型，降低复杂度         |            |
|          |                |             | - 采用渐进式架构演进策略             |            |
|          |                |             | - 明确三阶段实施路径                 |            |
| v1.3     | 规划中         | -           | 根据评审意见完善                     | 待启动     |

### C. 待办事项跟踪（更新）

#### 优先级 P0（本周完成）

| 任务             | 负责人     | 状态   | 预计完成    | 备注         |
| ---------------- | ---------- | ------ | ----------- | ------------ |
| 技术架构方案评审 | 技术负责人 | 进行中 | 12 月 12 日 | 需要三方评审 |
| 第一阶段详细设计 | 架构师     | 待开始 | 12 月 15 日 | 基于新架构   |
| 数据库表结构定稿 | DBA        | 进行中 | 12 月 13 日 | 已完成 80%   |
| 原型设计评审     | UI 设计师  | 已完成 | 12 月 11 日 | 已通过       |

#### 优先级 P1（本月完成）

| 任务         | 负责人     | 状态   | 预计完成    | 备注            |
| ------------ | ---------- | ------ | ----------- | --------------- |
| 开发环境搭建 | 运维工程师 | 待开始 | 12 月 20 日 | 需要采购服务器  |
| 核心代码框架 | 开发组长   | 待开始 | 12 月 25 日 | 基于 Go 或 Java |
| 支付接口对接 | 支付开发   | 待开始 | 12 月 28 日 | 微信支付优先    |
| 测试用例设计 | 测试负责人 | 待开始 | 12 月 22 日 | 覆盖核心流程    |

#### 优先级 P2（下月完成）

| 任务           | 负责人     | 状态   | 预计完成   | 备注               |
| -------------- | ---------- | ------ | ---------- | ------------------ |
| 第一版功能开发 | 开发团队   | 待开始 | 1 月 15 日 | 核心购票流程       |
| 商户入驻流程   | 产品经理   | 待开始 | 1 月 10 日 | 需要资质审核       |
| 监控系统搭建   | 运维工程师 | 待开始 | 1 月 5 日  | Prometheus+Grafana |
| 安全测试准备   | 安全工程师 | 待开始 | 1 月 8 日  | 渗透测试方案       |

#### 优先级 P3（后续阶段）

| 任务         | 负责人     | 状态   | 预计完成   | 备注            |
| ------------ | ---------- | ------ | ---------- | --------------- |
| 活动系统开发 | 开发团队   | 待开始 | 2 月 28 日 | 第二阶段        |
| 积分系统完善 | 产品经理   | 待开始 | 3 月 15 日 | 第二阶段        |
| 数据分析平台 | 数据工程师 | 待开始 | 3 月 31 日 | ClickHouse 集成 |
| 智能推荐系统 | 算法工程师 | 待开始 | 6 月 30 日 | 第三阶段        |

---

## 文档状态说明

**文档版本**：v1.2（务实渐进式架构版）
**文档状态**：✅ 完整版（已完成全部 11 章节）
**文档字数**：约 45,000 字
**最后更新**：2025 年 12 月 10 日
**评审状态**：待技术评审委员会评审

**核心价值总结**：

1. **务实架构**：从 13+微服务简化为 4 服务，降低复杂度
2. **渐进演进**：三阶段实施，避免过度设计
3. **团队友好**：技术栈选择务实，降低学习成本
4. **风险可控**：明确的风险控制计划
5. **商业可行**：成本预算合理，ROI 清晰

**文档结束**
