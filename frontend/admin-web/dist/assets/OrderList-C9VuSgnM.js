import{r as k}from"./request-Bjar9GtG.js";import{_ as te,r as _,h as ae,c as $,o as D,b as t,w as a,d as i,E as N,g as z,f as r,t as d,k as A,l as x,m as G}from"./index-CnV6pd1g.js";function le(b){return k({url:`/orders/${b}/cancel`,method:"post"})}function oe(b){return k({url:`/orders/${b}`,method:"get"})}function re(){return k({url:"/orders",method:"get"})}function se(b,p){return k({url:`/verifications/${b}/verify`,method:"post",params:{staffId:p}})}function ne(b,p){return k({url:`/verifications/batch/${b}`,method:"post",params:{staffId:p}})}const ue={class:"order-list"},ie={class:"pagination"},de={key:0},pe={__name:"OrderList",setup(b){const p=_({orderNo:"",status:""}),h=_([]),C=_(1),w=_(10),E=_(0),P=_(!1),s=_(null),V=_(!1),v=_({verificationCode:"",visitorName:"",staffId:1}),g=async()=>{try{const o=await re();if(o.success){let e=[];Array.isArray(o.data)?e=o.data:o.data&&Array.isArray(o.data.records)?(e=o.data.records,E.value=o.data.total||0):o.data&&o.data.data&&Array.isArray(o.data.data)?e=o.data.data:(console.warn("Unexpected response format:",o.data),e=[]),p.value.orderNo&&(e=e.filter(f=>f.orderNo&&f.orderNo.includes(p.value.orderNo))),p.value.status&&(e=e.filter(f=>f.status===p.value.status)),o.data.total||(E.value=e.length);const u=(C.value-1)*w.value,c=u+w.value;h.value=e.slice(u,c)}else console.error("Response not successful:",o),h.value=[],E.value=0}catch(o){console.error("OrderList loadOrders error:",o),N.error("加载订单列表失败: "+(o.message||"未知错误")),h.value=[],E.value=0}},U=async o=>{try{const e=await oe(o.id);e.success&&(s.value=e.data,P.value=!0)}catch(e){console.error("OrderList handleView error:",e),N.error("加载订单详情失败")}},F=o=>{G.confirm("确定要取消该订单吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{var e,u;try{(await le(o.id)).success&&(N.success("订单已取消"),g())}catch(c){N.error(((u=(e=c.response)==null?void 0:e.data)==null?void 0:u.message)||"取消订单失败")}})},R=o=>{G.prompt("请输入核销员ID","批量核销",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^\d+$/,inputErrorMessage:"请输入有效的核销员ID"}).then(async({value:e})=>{var u,c;try{(await ne(o.id,parseInt(e))).success&&(N.success("批量核销成功"),g())}catch(f){N.error(((c=(u=f.response)==null?void 0:u.data)==null?void 0:c.message)||"批量核销失败")}})},Y=o=>{v.value={verificationCode:o.verificationCode,visitorName:o.visitorName,staffId:1},V.value=!0},j=async()=>{var o,e;try{(await se(v.value.verificationCode,v.value.staffId)).data.success&&(N.success("核销成功"),V.value=!1,U(s.value))}catch(u){N.error(((e=(o=u.response)==null?void 0:o.data)==null?void 0:e.message)||"核销失败")}},q=()=>{C.value=1,g()},H=()=>{p.value={orderNo:"",status:""},C.value=1,g()},J=()=>{g()},K=()=>{g()},M=o=>({PENDING_PAYMENT:"warning",PENDING_USE:"info",COMPLETED:"success",CANCELLED:"danger",REFUNDED:"info"})[o]||"info",L=o=>({PENDING_PAYMENT:"待支付",PENDING_USE:"待使用",COMPLETED:"已完成",CANCELLED:"已取消",REFUNDED:"已退款"})[o]||o;return ae(()=>{g()}),(o,e)=>{const u=i("el-input"),c=i("el-form-item"),f=i("el-option"),Q=i("el-select"),y=i("el-button"),O=i("el-form"),n=i("el-table-column"),I=i("el-tag"),S=i("el-table"),W=i("el-pagination"),X=i("el-card"),m=i("el-descriptions-item"),Z=i("el-descriptions"),B=i("el-dialog"),ee=i("el-input-number");return D(),$("div",ue,[t(X,null,{default:a(()=>[t(O,{inline:!0,model:p.value,class:"search-form"},{default:a(()=>[t(c,{label:"订单号"},{default:a(()=>[t(u,{modelValue:p.value.orderNo,"onUpdate:modelValue":e[0]||(e[0]=l=>p.value.orderNo=l),placeholder:"请输入订单号",clearable:""},null,8,["modelValue"])]),_:1}),t(c,{label:"订单状态"},{default:a(()=>[t(Q,{modelValue:p.value.status,"onUpdate:modelValue":e[1]||(e[1]=l=>p.value.status=l),placeholder:"请选择状态",clearable:"",style:{width:"200px"}},{default:a(()=>[t(f,{label:"待支付",value:"PENDING_PAYMENT"}),t(f,{label:"待使用",value:"PENDING_USE"}),t(f,{label:"已完成",value:"COMPLETED"}),t(f,{label:"已取消",value:"CANCELLED"}),t(f,{label:"已退款",value:"REFUNDED"})]),_:1},8,["modelValue"])]),_:1}),t(c,null,{default:a(()=>[t(y,{type:"primary",onClick:q},{default:a(()=>[...e[10]||(e[10]=[r("查询",-1)])]),_:1}),t(y,{onClick:H},{default:a(()=>[...e[11]||(e[11]=[r("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),t(S,{data:h.value,stripe:"",style:{width:"100%"}},{default:a(()=>[t(n,{prop:"orderNo",label:"订单号",width:"180"}),t(n,{prop:"contactName",label:"联系人",width:"120"}),t(n,{prop:"contactPhone",label:"联系电话",width:"130"}),t(n,{prop:"visitDate",label:"游玩日期",width:"120"}),t(n,{prop:"visitorCount",label:"人数",width:"80"}),t(n,{prop:"actualAmount",label:"实付金额",width:"100"},{default:a(({row:l})=>[r(" ¥"+d(l.actualAmount),1)]),_:1}),t(n,{prop:"status",label:"订单状态",width:"100"},{default:a(({row:l})=>[t(I,{type:M(l.status)},{default:a(()=>[r(d(L(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(n,{prop:"createTime",label:"创建时间",width:"180"}),t(n,{label:"操作",fixed:"right",width:"200"},{default:a(({row:l})=>[t(y,{link:"",type:"primary",onClick:T=>U(l)},{default:a(()=>[...e[12]||(e[12]=[r("查看",-1)])]),_:1},8,["onClick"]),l.status==="PENDING_USE"?(D(),A(y,{key:0,link:"",type:"success",onClick:T=>R(l)},{default:a(()=>[...e[13]||(e[13]=[r(" 批量核销 ",-1)])]),_:1},8,["onClick"])):x("",!0),l.status==="PENDING_PAYMENT"?(D(),A(y,{key:1,link:"",type:"danger",onClick:T=>F(l)},{default:a(()=>[...e[14]||(e[14]=[r(" 取消 ",-1)])]),_:1},8,["onClick"])):x("",!0)]),_:1})]),_:1},8,["data"]),z("div",ie,[t(W,{"current-page":C.value,"onUpdate:currentPage":e[2]||(e[2]=l=>C.value=l),"page-size":w.value,"onUpdate:pageSize":e[3]||(e[3]=l=>w.value=l),total:E.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:K},null,8,["current-page","page-size","total"])])]),_:1}),t(B,{modelValue:P.value,"onUpdate:modelValue":e[4]||(e[4]=l=>P.value=l),title:"订单详情",width:"70%"},{default:a(()=>[s.value?(D(),$("div",de,[t(Z,{column:2,border:""},{default:a(()=>[t(m,{label:"订单号"},{default:a(()=>[r(d(s.value.orderNo),1)]),_:1}),t(m,{label:"订单状态"},{default:a(()=>[t(I,{type:M(s.value.status)},{default:a(()=>[r(d(L(s.value.status)),1)]),_:1},8,["type"])]),_:1}),t(m,{label:"联系人"},{default:a(()=>[r(d(s.value.contactName),1)]),_:1}),t(m,{label:"联系电话"},{default:a(()=>[r(d(s.value.contactPhone),1)]),_:1}),t(m,{label:"游玩日期"},{default:a(()=>[r(d(s.value.visitDate),1)]),_:1}),t(m,{label:"游客人数"},{default:a(()=>[r(d(s.value.visitorCount),1)]),_:1}),t(m,{label:"订单金额"},{default:a(()=>[r("¥"+d(s.value.totalAmount),1)]),_:1}),t(m,{label:"实付金额"},{default:a(()=>[r("¥"+d(s.value.actualAmount),1)]),_:1}),t(m,{label:"创建时间"},{default:a(()=>[r(d(s.value.createTime),1)]),_:1}),t(m,{label:"支付时间"},{default:a(()=>[r(d(s.value.payTime||"-"),1)]),_:1}),t(m,{label:"备注",span:2},{default:a(()=>[r(d(s.value.remark||"-"),1)]),_:1})]),_:1}),e[16]||(e[16]=z("h3",{style:{"margin-top":"20px"}},"票券信息",-1)),t(S,{data:s.value.items,stripe:"",style:{width:"100%"}},{default:a(()=>[t(n,{prop:"visitorName",label:"游客姓名"}),t(n,{prop:"visitorIdCard",label:"身份证号"}),t(n,{prop:"price",label:"票价"},{default:a(({row:l})=>[r("¥"+d(l.price),1)]),_:1}),t(n,{prop:"verificationCode",label:"核销码",width:"280"}),t(n,{prop:"isVerified",label:"核销状态",width:"100"},{default:a(({row:l})=>[t(I,{type:l.isVerified?"success":"warning"},{default:a(()=>[r(d(l.isVerified?"已核销":"未核销"),1)]),_:2},1032,["type"])]),_:1}),t(n,{prop:"verifyTime",label:"核销时间",width:"180"}),t(n,{label:"操作",width:"120"},{default:a(({row:l})=>[l.isVerified?x("",!0):(D(),A(y,{key:0,link:"",type:"success",onClick:T=>Y(l)},{default:a(()=>[...e[15]||(e[15]=[r(" 核销 ",-1)])]),_:1},8,["onClick"]))]),_:1})]),_:1},8,["data"])])):x("",!0)]),_:1},8,["modelValue"]),t(B,{modelValue:V.value,"onUpdate:modelValue":e[9]||(e[9]=l=>V.value=l),title:"核销票券",width:"400px"},{footer:a(()=>[t(y,{onClick:e[8]||(e[8]=l=>V.value=!1)},{default:a(()=>[...e[17]||(e[17]=[r("取消",-1)])]),_:1}),t(y,{type:"primary",onClick:j},{default:a(()=>[...e[18]||(e[18]=[r("确认核销",-1)])]),_:1})]),default:a(()=>[t(O,{model:v.value,"label-width":"100px"},{default:a(()=>[t(c,{label:"核销码"},{default:a(()=>[t(u,{modelValue:v.value.verificationCode,"onUpdate:modelValue":e[5]||(e[5]=l=>v.value.verificationCode=l),disabled:""},null,8,["modelValue"])]),_:1}),t(c,{label:"游客姓名"},{default:a(()=>[t(u,{modelValue:v.value.visitorName,"onUpdate:modelValue":e[6]||(e[6]=l=>v.value.visitorName=l),disabled:""},null,8,["modelValue"])]),_:1}),t(c,{label:"核销员ID"},{default:a(()=>[t(ee,{modelValue:v.value.staffId,"onUpdate:modelValue":e[7]||(e[7]=l=>v.value.staffId=l),min:1},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},me=te(pe,[["__scopeId","data-v-ab64bb5a"]]);export{me as default};
