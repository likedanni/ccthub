import{a as le,e as te,f as ae,h as oe,s as re}from"./ticket-B17mwe56.js";import{_ as ie,C as ne,r as m,a as E,h as se,c as de,o as F,b as e,w as a,q as D,D as ue,d as n,E as v,u as ce,i as pe,g as k,t as f,j as me,k as ve,f as d,y as fe,z as ge,A as ye,m as _e}from"./index-D83cRL-0.js";import"./request-Bsn8Vm96.js";const be={class:"ticket-price-calendar"},Te={class:"page-title"},Ve={class:"card-header"},ke={class:"sell-price"},Pe={__name:"TicketPriceCalendar",setup(De){const M=ce(),w=ne().params.ticketId,h=m(""),C=m([]),R=m(!1),g=m(!1),b=m(!1),T=m(!1),x=m(null),U=m(null),i=E({dateRange:[],priceType:1,originalPrice:0,sellPrice:0,inventoryTotal:0,isActive:!0}),r=E({id:null,ticketId:null,priceDate:"",priceType:1,originalPrice:0,sellPrice:0,inventoryTotal:0,isActive:!0}),N={dateRange:[{required:!0,message:"请选择日期范围",trigger:"change"}],priceType:[{required:!0,message:"请选择价格类型",trigger:"change"}],originalPrice:[{required:!0,message:"请输入原价",trigger:"blur"}],sellPrice:[{required:!0,message:"请输入售价",trigger:"blur"}],inventoryTotal:[{required:!0,message:"请输入总库存",trigger:"blur"}]},$={priceType:[{required:!0,message:"请选择价格类型",trigger:"change"}],originalPrice:[{required:!0,message:"请输入原价",trigger:"blur"}],sellPrice:[{required:!0,message:"请输入售价",trigger:"blur"}],inventoryTotal:[{required:!0,message:"请输入总库存",trigger:"blur"}]},Y=async()=>{try{const o=await le(w);h.value=o.name}catch{v.error("加载票种信息失败")}},P=async()=>{R.value=!0;try{const o=await te(w);C.value=(o||[]).map(l=>({...l,occupancyRate:(l.inventorySold+l.inventoryLocked)/l.inventoryTotal*100}))}catch{v.error("加载票价列表失败")}finally{R.value=!1}},z=async()=>{await x.value.validate(),g.value=!0;try{const[o,l]=i.dateRange,A=new Date(o),c=new Date(l),u=[];for(let y=new Date(A);y<=c;y.setDate(y.getDate()+1))u.push({ticketId:Number(w),priceDate:y.toISOString().split("T")[0],priceType:i.priceType,originalPrice:i.originalPrice,sellPrice:i.sellPrice,inventoryTotal:i.inventoryTotal,isActive:i.isActive});await oe(u),v.success("批量设置成功"),b.value=!1,P()}catch{v.error("批量设置失败")}finally{g.value=!1}},L=o=>{r.id=o.id,r.ticketId=o.ticketId,r.priceDate=o.priceDate,r.priceType=o.priceType,r.originalPrice=o.originalPrice,r.sellPrice=o.sellPrice,r.inventoryTotal=o.inventoryTotal,r.isActive=o.isActive,T.value=!0},O=async()=>{await U.value.validate(),g.value=!0;try{await re(r),v.success("修改成功"),T.value=!1,P()}catch{v.error("修改失败")}finally{g.value=!1}},j=o=>{_e.confirm("确定要删除该票价吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ae(o.id),v.success("删除成功"),P()}catch{v.error("删除失败")}}).catch(()=>{})},G=()=>{M.push("/tickets/list")},H=o=>o<50?"#67c23a":o<80?"#e6a23c":"#f56c6c";return se(()=>{Y(),P()}),(o,l)=>{const A=n("el-page-header"),c=n("el-button"),u=n("el-table-column"),y=n("el-divider"),V=n("el-tag"),J=n("el-progress"),K=n("el-table"),Q=n("el-card"),W=n("el-date-picker"),s=n("el-form-item"),p=n("el-option"),B=n("el-select"),_=n("el-input-number"),q=n("el-switch"),I=n("el-form"),S=n("el-dialog"),X=n("el-input"),Z=pe("loading");return F(),de("div",be,[e(A,{onBack:G,icon:D(ue)},{content:a(()=>[k("span",Te,"票价日历 - "+f(h.value),1)]),_:1},8,["icon"]),e(Q,{class:"calendar-card"},{header:a(()=>[k("div",Ve,[l[18]||(l[18]=k("span",null,"价格与库存设置",-1)),e(c,{type:"primary",onClick:l[0]||(l[0]=t=>b.value=!0),icon:D(ye)},{default:a(()=>[...l[17]||(l[17]=[d(" 批量设置 ",-1)])]),_:1},8,["icon"])])]),default:a(()=>[me((F(),ve(K,{data:C.value,border:""},{default:a(()=>[e(u,{prop:"priceDate",label:"日期",width:"120"}),e(u,{prop:"priceTypeText",label:"价格类型",width:"120"}),e(u,{label:"价格",width:"200"},{default:a(({row:t})=>[k("span",null,"原价：¥"+f(t.originalPrice),1),e(y,{direction:"vertical"}),k("span",ke,"售价：¥"+f(t.sellPrice),1)]),_:1}),e(u,{label:"库存",width:"300"},{default:a(({row:t})=>[e(V,{type:"success"},{default:a(()=>[d("总计："+f(t.inventoryTotal),1)]),_:2},1024),e(V,{type:"primary"},{default:a(()=>[d("可用："+f(t.inventoryAvailable),1)]),_:2},1024),e(V,{type:"warning"},{default:a(()=>[d("锁定："+f(t.inventoryLocked),1)]),_:2},1024),e(V,{type:"danger"},{default:a(()=>[d("已售："+f(t.inventorySold),1)]),_:2},1024)]),_:1}),e(u,{prop:"isActive",label:"状态",width:"100"},{default:a(({row:t})=>[e(V,{type:t.isActive?"success":"info"},{default:a(()=>[d(f(t.isActive?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),e(u,{label:"库存占用率",width:"150"},{default:a(({row:t})=>[e(J,{percentage:Math.round(t.occupancyRate),color:H(t.occupancyRate)},null,8,["percentage","color"])]),_:1}),e(u,{label:"操作",width:"180",fixed:"right"},{default:a(({row:t})=>[e(c,{type:"primary",size:"small",onClick:ee=>L(t),icon:D(fe)},{default:a(()=>[...l[19]||(l[19]=[d(" 编辑 ",-1)])]),_:1},8,["onClick","icon"]),e(c,{type:"danger",size:"small",onClick:ee=>j(t),icon:D(ge)},{default:a(()=>[...l[20]||(l[20]=[d(" 删除 ",-1)])]),_:1},8,["onClick","icon"])]),_:1})]),_:1},8,["data"])),[[Z,R.value]])]),_:1}),e(S,{modelValue:b.value,"onUpdate:modelValue":l[8]||(l[8]=t=>b.value=t),title:"批量设置票价",width:"600px"},{footer:a(()=>[e(c,{onClick:l[7]||(l[7]=t=>b.value=!1)},{default:a(()=>[...l[21]||(l[21]=[d("取消",-1)])]),_:1}),e(c,{type:"primary",onClick:z,loading:g.value},{default:a(()=>[...l[22]||(l[22]=[d(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[e(I,{ref_key:"batchFormRef",ref:x,model:i,rules:N,"label-width":"120px"},{default:a(()=>[e(s,{label:"日期范围",prop:"dateRange"},{default:a(()=>[e(W,{modelValue:i.dateRange,"onUpdate:modelValue":l[1]||(l[1]=t=>i.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),e(s,{label:"价格类型",prop:"priceType"},{default:a(()=>[e(B,{modelValue:i.priceType,"onUpdate:modelValue":l[2]||(l[2]=t=>i.priceType=t),placeholder:"请选择价格类型"},{default:a(()=>[e(p,{label:"成人票",value:1}),e(p,{label:"学生票",value:2}),e(p,{label:"儿童票",value:3}),e(p,{label:"老年票",value:4})]),_:1},8,["modelValue"])]),_:1}),e(s,{label:"原价",prop:"originalPrice"},{default:a(()=>[e(_,{modelValue:i.originalPrice,"onUpdate:modelValue":l[3]||(l[3]=t=>i.originalPrice=t),min:.01,precision:2,placeholder:"请输入原价"},null,8,["modelValue"])]),_:1}),e(s,{label:"售价",prop:"sellPrice"},{default:a(()=>[e(_,{modelValue:i.sellPrice,"onUpdate:modelValue":l[4]||(l[4]=t=>i.sellPrice=t),min:.01,precision:2,placeholder:"请输入售价"},null,8,["modelValue"])]),_:1}),e(s,{label:"总库存",prop:"inventoryTotal"},{default:a(()=>[e(_,{modelValue:i.inventoryTotal,"onUpdate:modelValue":l[5]||(l[5]=t=>i.inventoryTotal=t),min:0,placeholder:"请输入总库存"},null,8,["modelValue"])]),_:1}),e(s,{label:"是否启用",prop:"isActive"},{default:a(()=>[e(q,{modelValue:i.isActive,"onUpdate:modelValue":l[6]||(l[6]=t=>i.isActive=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(S,{modelValue:T.value,"onUpdate:modelValue":l[16]||(l[16]=t=>T.value=t),title:"编辑票价",width:"600px"},{footer:a(()=>[e(c,{onClick:l[15]||(l[15]=t=>T.value=!1)},{default:a(()=>[...l[23]||(l[23]=[d("取消",-1)])]),_:1}),e(c,{type:"primary",onClick:O,loading:g.value},{default:a(()=>[...l[24]||(l[24]=[d(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[e(I,{ref_key:"editFormRef",ref:U,model:r,rules:$,"label-width":"120px"},{default:a(()=>[e(s,{label:"日期"},{default:a(()=>[e(X,{modelValue:r.priceDate,"onUpdate:modelValue":l[9]||(l[9]=t=>r.priceDate=t),disabled:""},null,8,["modelValue"])]),_:1}),e(s,{label:"价格类型",prop:"priceType"},{default:a(()=>[e(B,{modelValue:r.priceType,"onUpdate:modelValue":l[10]||(l[10]=t=>r.priceType=t),placeholder:"请选择价格类型"},{default:a(()=>[e(p,{label:"成人票",value:1}),e(p,{label:"学生票",value:2}),e(p,{label:"儿童票",value:3}),e(p,{label:"老年票",value:4})]),_:1},8,["modelValue"])]),_:1}),e(s,{label:"原价",prop:"originalPrice"},{default:a(()=>[e(_,{modelValue:r.originalPrice,"onUpdate:modelValue":l[11]||(l[11]=t=>r.originalPrice=t),min:.01,precision:2,placeholder:"请输入原价"},null,8,["modelValue"])]),_:1}),e(s,{label:"售价",prop:"sellPrice"},{default:a(()=>[e(_,{modelValue:r.sellPrice,"onUpdate:modelValue":l[12]||(l[12]=t=>r.sellPrice=t),min:.01,precision:2,placeholder:"请输入售价"},null,8,["modelValue"])]),_:1}),e(s,{label:"总库存",prop:"inventoryTotal"},{default:a(()=>[e(_,{modelValue:r.inventoryTotal,"onUpdate:modelValue":l[13]||(l[13]=t=>r.inventoryTotal=t),min:0,placeholder:"请输入总库存"},null,8,["modelValue"])]),_:1}),e(s,{label:"是否启用"},{default:a(()=>[e(q,{modelValue:r.isActive,"onUpdate:modelValue":l[14]||(l[14]=t=>r.isActive=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ce=ie(Pe,[["__scopeId","data-v-14382094"]]);export{Ce as default};
