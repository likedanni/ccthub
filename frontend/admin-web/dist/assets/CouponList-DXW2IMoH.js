import{g as ee,u as le,c as ae,a as te,b as oe}from"./coupon-f-_UUiC3.js";import{_ as ue,r as _,h as ne,c as re,o as T,b as l,w as t,d as m,E as s,i as de,j as se,f as d,k as U,t as C,g as c,l as $,m as ie}from"./index-BxrhVYt3.js";import"./request-Cl0XkbGx.js";const me={class:"coupon-list"},pe={class:"card-header"},fe={style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},ve={__name:"CouponList",setup(ye){const z=_(!1),y=_({name:"",couponType:null,status:null}),k=_([]),V=_({page:1,size:10,total:0}),u=_({visible:!1,form:{name:"",type:1,value:0,minSpend:0,applicableType:1,applicableIds:"",validityType:1,validDays:7,startsAt:null,expiresAt:null,totalQuantity:100,limitPerUser:1,status:1}}),r=_({visible:!1,form:{}}),f=_({visible:!1,couponId:null,couponName:"",form:{userIds:[]},userIdsInput:""}),E={1:"满减券",2:"折扣券",3:"代金券"},F=o=>E[o]||"未知",P=o=>({1:"success",2:"warning",3:"primary"})[o]||"",Q=o=>o.couponType===1?`减${o.discountAmount}元`:o.couponType===2?`${o.discountRate}折`:o.couponType===3?`${o.discountAmount}元`:"-",g=async()=>{z.value=!0;try{const o={name:y.value.name,type:y.value.couponType,status:y.value.status,page:V.value.page-1,size:V.value.size},e=await ee(o);e.success&&e.data?(k.value=e.data.records||[],V.value.total=e.data.total||0):(k.value=[],V.value.total=0,s.error(e.message||"获取数据失败"))}catch(o){console.error("查询优惠券列表失败:",o),s.error("查询失败："+(o.message||"未知错误")),k.value=[],V.value.total=0}finally{z.value=!1}},M=()=>{y.value={name:"",couponType:null,status:null},g()},j=()=>{u.value.form={name:"",type:1,value:0,minSpend:0,applicableType:1,applicableIds:"",validityType:1,validDays:7,startsAt:null,expiresAt:null,totalQuantity:100,limitPerUser:1,status:1},u.value.visible=!0},G=o=>{r.value.visible=!0,r.value.form={...o}},L=o=>{f.value.visible=!0,f.value.couponId=o.id,f.value.couponName=o.name,f.value.form={userIds:[]}},R=async o=>{const e=o.status===1?"禁用":"启用",i=o.status===1?3:1;try{await ie.confirm(`确定要${e}该优惠券吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await le(o.id,i),s.success(`${e}成功`),g()}catch(v){v!=="cancel"&&s.error(`${e}失败：`+(v.message||"未知错误"))}},H=async()=>{try{const o=u.value.form;if(!o.name){s.warning("请输入优惠券名称");return}if(o.value<=0){s.warning("请输入有效的优惠值");return}if(o.totalQuantity<=0){s.warning("请输入有效的发放总量");return}if(o.limitPerUser<=0){s.warning("请输入有效的限领数量");return}if(o.validityType===1){if(!o.startsAt||!o.expiresAt){s.warning("请选择有效期时间");return}if(new Date(o.startsAt)>=new Date(o.expiresAt)){s.warning("有效期结束时间必须大于开始时间");return}}else if(o.validDays<=0){s.warning("请输入有效天数");return}await ae(o),s.success("创建成功"),u.value.visible=!1,g()}catch(o){s.error("创建失败："+(o.message||"未知错误"))}},J=async()=>{try{const o={name:r.value.form.name,totalCount:r.value.form.totalCount,minAmount:r.value.form.minAmount,validFrom:r.value.form.validFrom,validTo:r.value.form.validTo};await te(r.value.form.id,o),s.success("编辑成功"),r.value.visible=!1,g()}catch(o){s.error("编辑失败："+(o.message||"未知错误"))}},K=async()=>{try{const o=f.value.userIdsInput.trim();if(!o){s.warning("请输入用户ID");return}const e=o.split(/[,\n\s]+/).map(n=>n.trim()).filter(n=>n&&/^\d+$/.test(n)).map(n=>parseInt(n));if(e.length===0){s.warning("没有有效的用户ID");return}let i=0,v=0;for(const n of e)try{await oe(f.value.couponId,{userId:n}),i++}catch(p){v++,console.error(`发放给用户${n}失败:`,p)}i>0?(s.success(`成功发放${i}个用户${v>0?`，失败${v}个`:""}`),f.value.visible=!1,f.value.userIdsInput=""):s.error("发放失败，请检查用户ID是否有效")}catch(o){s.error("发放失败："+(o.message||"未知错误"))}};return ne(()=>{g()}),(o,e)=>{const i=m("el-button"),v=m("el-input"),n=m("el-form-item"),p=m("el-option"),x=m("el-select"),D=m("el-form"),b=m("el-table-column"),q=m("el-tag"),O=m("el-table"),W=m("el-pagination"),X=m("el-card"),w=m("el-input-number"),I=m("el-radio"),N=m("el-radio-group"),A=m("el-date-picker"),S=m("el-dialog"),Y=m("el-alert"),Z=m("el-text"),h=de("loading");return T(),re("div",me,[l(X,null,{header:t(()=>[c("div",pe,[e[32]||(e[32]=c("span",null,"优惠券管理",-1)),l(i,{type:"primary",onClick:j},{default:t(()=>[...e[31]||(e[31]=[d("创建优惠券",-1)])]),_:1})])]),default:t(()=>[l(D,{inline:!0,model:y.value,class:"search-form"},{default:t(()=>[l(n,{label:"优惠券名称"},{default:t(()=>[l(v,{modelValue:y.value.name,"onUpdate:modelValue":e[0]||(e[0]=a=>y.value.name=a),placeholder:"请输入优惠券名称",clearable:""},null,8,["modelValue"])]),_:1}),l(n,{label:"优惠券类型"},{default:t(()=>[l(x,{modelValue:y.value.couponType,"onUpdate:modelValue":e[1]||(e[1]=a=>y.value.couponType=a),placeholder:"请选择类型",clearable:""},{default:t(()=>[l(p,{label:"满减券",value:1}),l(p,{label:"折扣券",value:2}),l(p,{label:"代金券",value:3})]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"状态"},{default:t(()=>[l(x,{modelValue:y.value.status,"onUpdate:modelValue":e[2]||(e[2]=a=>y.value.status=a),placeholder:"请选择状态",clearable:""},{default:t(()=>[l(p,{label:"发放中",value:1}),l(p,{label:"停用",value:3})]),_:1},8,["modelValue"])]),_:1}),l(n,null,{default:t(()=>[l(i,{type:"primary",onClick:g},{default:t(()=>[...e[33]||(e[33]=[d("查询",-1)])]),_:1}),l(i,{onClick:M},{default:t(()=>[...e[34]||(e[34]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),se((T(),U(O,{data:k.value,border:"",style:{width:"100%"}},{default:t(()=>[l(b,{prop:"id",label:"ID",width:"80"}),l(b,{prop:"name",label:"优惠券名称",width:"180"}),l(b,{prop:"couponType",label:"类型",width:"100"},{default:t(a=>[l(q,{type:P(a.row.couponType)},{default:t(()=>[d(C(F(a.row.couponType)),1)]),_:2},1032,["type"])]),_:1}),l(b,{prop:"discount",label:"优惠",width:"120"},{default:t(a=>[d(C(Q(a.row)),1)]),_:1}),l(b,{prop:"minAmount",label:"最低消费",width:"100"},{default:t(a=>[d(C(a.row.minAmount?`¥${a.row.minAmount}`:"无门槛"),1)]),_:1}),l(b,{prop:"totalCount",label:"发放总量",width:"100"}),l(b,{prop:"usedCount",label:"已使用",width:"100"}),l(b,{prop:"validFrom",label:"有效期开始",width:"160"}),l(b,{prop:"validTo",label:"有效期结束",width:"160"}),l(b,{prop:"status",label:"状态",width:"80"},{default:t(a=>[l(q,{type:a.row.status===1?"success":"info"},{default:t(()=>[d(C(a.row.status===1?"生效中":"已失效"),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"操作",width:"200",fixed:"right"},{default:t(a=>[l(i,{type:"primary",size:"small",onClick:B=>G(a.row)},{default:t(()=>[...e[35]||(e[35]=[d("编辑",-1)])]),_:1},8,["onClick"]),l(i,{type:"success",size:"small",onClick:B=>L(a.row)},{default:t(()=>[...e[36]||(e[36]=[d("发放",-1)])]),_:1},8,["onClick"]),l(i,{type:a.row.status===1?"danger":"success",size:"small",onClick:B=>R(a.row)},{default:t(()=>[d(C(a.row.status===1?"禁用":"启用"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[h,z.value]]),l(W,{"current-page":V.value.page,"onUpdate:currentPage":e[3]||(e[3]=a=>V.value.page=a),"page-size":V.value.size,"onUpdate:pageSize":e[4]||(e[4]=a=>V.value.size=a),total:V.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:g,onCurrentChange:g,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),l(S,{modelValue:u.value.visible,"onUpdate:modelValue":e[19]||(e[19]=a=>u.value.visible=a),title:"创建优惠券",width:"700px"},{footer:t(()=>[l(i,{onClick:e[18]||(e[18]=a=>u.value.visible=!1)},{default:t(()=>[...e[44]||(e[44]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:H},{default:t(()=>[...e[45]||(e[45]=[d("确定创建",-1)])]),_:1})]),default:t(()=>[l(D,{model:u.value.form,"label-width":"120px"},{default:t(()=>[l(n,{label:"优惠券名称",required:""},{default:t(()=>[l(v,{modelValue:u.value.form.name,"onUpdate:modelValue":e[5]||(e[5]=a=>u.value.form.name=a),placeholder:"请输入优惠券名称"},null,8,["modelValue"])]),_:1}),l(n,{label:"优惠券类型",required:""},{default:t(()=>[l(x,{modelValue:u.value.form.type,"onUpdate:modelValue":e[6]||(e[6]=a=>u.value.form.type=a),placeholder:"请选择类型"},{default:t(()=>[l(p,{label:"满减券",value:1}),l(p,{label:"折扣券",value:2}),l(p,{label:"代金券",value:3})]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"优惠值",required:""},{default:t(()=>[l(w,{modelValue:u.value.form.value,"onUpdate:modelValue":e[7]||(e[7]=a=>u.value.form.value=a),min:0,precision:2,placeholder:u.value.form.type===2?"折扣率(如8.5表示8.5折)":"优惠金额"},null,8,["modelValue","placeholder"]),c("span",fe,C(u.value.form.type===1?"满减金额":u.value.form.type===2?"折扣率(如8.5)":"代金券金额"),1)]),_:1}),l(n,{label:"最低消费金额"},{default:t(()=>[l(w,{modelValue:u.value.form.minSpend,"onUpdate:modelValue":e[8]||(e[8]=a=>u.value.form.minSpend=a),min:0,precision:2},null,8,["modelValue"]),e[37]||(e[37]=c("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},"0表示无门槛",-1))]),_:1}),l(n,{label:"适用范围"},{default:t(()=>[l(x,{modelValue:u.value.form.applicableType,"onUpdate:modelValue":e[9]||(e[9]=a=>u.value.form.applicableType=a),placeholder:"请选择适用范围"},{default:t(()=>[l(p,{label:"全平台",value:1}),l(p,{label:"指定商户",value:2}),l(p,{label:"指定商品",value:3})]),_:1},8,["modelValue"])]),_:1}),u.value.form.applicableType!==1?(T(),U(n,{key:0,label:"适用ID"},{default:t(()=>[l(v,{modelValue:u.value.form.applicableIds,"onUpdate:modelValue":e[10]||(e[10]=a=>u.value.form.applicableIds=a),type:"textarea",rows:2,placeholder:"多个ID用逗号分隔，如: 1,2,3"},null,8,["modelValue"])]),_:1})):$("",!0),l(n,{label:"有效期类型",required:""},{default:t(()=>[l(N,{modelValue:u.value.form.validityType,"onUpdate:modelValue":e[11]||(e[11]=a=>u.value.form.validityType=a)},{default:t(()=>[l(I,{label:1},{default:t(()=>[...e[38]||(e[38]=[d("固定时段",-1)])]),_:1}),l(I,{label:2},{default:t(()=>[...e[39]||(e[39]=[d("领取后生效",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),u.value.form.validityType===1?(T(),U(n,{key:1,label:"有效期开始",required:""},{default:t(()=>[l(A,{modelValue:u.value.form.startsAt,"onUpdate:modelValue":e[12]||(e[12]=a=>u.value.form.startsAt=a),type:"datetime",placeholder:"选择开始时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1})):$("",!0),u.value.form.validityType===1?(T(),U(n,{key:2,label:"有效期结束",required:""},{default:t(()=>[l(A,{modelValue:u.value.form.expiresAt,"onUpdate:modelValue":e[13]||(e[13]=a=>u.value.form.expiresAt=a),type:"datetime",placeholder:"选择结束时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1})):$("",!0),u.value.form.validityType===2?(T(),U(n,{key:3,label:"有效天数",required:""},{default:t(()=>[l(w,{modelValue:u.value.form.validDays,"onUpdate:modelValue":e[14]||(e[14]=a=>u.value.form.validDays=a),min:1},null,8,["modelValue"]),e[40]||(e[40]=c("span",{style:{"margin-left":"10px",color:"#909399","font-size":"12px"}},"领取后N天内有效",-1))]),_:1})):$("",!0),l(n,{label:"发放总量",required:""},{default:t(()=>[l(w,{modelValue:u.value.form.totalQuantity,"onUpdate:modelValue":e[15]||(e[15]=a=>u.value.form.totalQuantity=a),min:1},null,8,["modelValue"])]),_:1}),l(n,{label:"每人限领",required:""},{default:t(()=>[l(w,{modelValue:u.value.form.limitPerUser,"onUpdate:modelValue":e[16]||(e[16]=a=>u.value.form.limitPerUser=a),min:1},null,8,["modelValue"])]),_:1}),l(n,{label:"状态"},{default:t(()=>[l(N,{modelValue:u.value.form.status,"onUpdate:modelValue":e[17]||(e[17]=a=>u.value.form.status=a)},{default:t(()=>[l(I,{label:0},{default:t(()=>[...e[41]||(e[41]=[d("未开始",-1)])]),_:1}),l(I,{label:1},{default:t(()=>[...e[42]||(e[42]=[d("发放中",-1)])]),_:1}),l(I,{label:3},{default:t(()=>[...e[43]||(e[43]=[d("停用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(S,{modelValue:r.value.visible,"onUpdate:modelValue":e[27]||(e[27]=a=>r.value.visible=a),title:"编辑优惠券",width:"600px"},{footer:t(()=>[l(i,{onClick:e[26]||(e[26]=a=>r.value.visible=!1)},{default:t(()=>[...e[46]||(e[46]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:J},{default:t(()=>[...e[47]||(e[47]=[d("确定",-1)])]),_:1})]),default:t(()=>[l(D,{model:r.value.form,"label-width":"120px"},{default:t(()=>[l(n,{label:"优惠券名称"},{default:t(()=>[l(v,{modelValue:r.value.form.name,"onUpdate:modelValue":e[20]||(e[20]=a=>r.value.form.name=a)},null,8,["modelValue"])]),_:1}),l(n,{label:"优惠券类型"},{default:t(()=>[l(x,{modelValue:r.value.form.couponType,"onUpdate:modelValue":e[21]||(e[21]=a=>r.value.form.couponType=a),disabled:""},{default:t(()=>[l(p,{label:"满减券",value:1}),l(p,{label:"折扣券",value:2}),l(p,{label:"代金券",value:3})]),_:1},8,["modelValue"])]),_:1}),l(n,{label:"发放总量"},{default:t(()=>[l(w,{modelValue:r.value.form.totalCount,"onUpdate:modelValue":e[22]||(e[22]=a=>r.value.form.totalCount=a),min:0},null,8,["modelValue"])]),_:1}),l(n,{label:"最低消费金额"},{default:t(()=>[l(w,{modelValue:r.value.form.minAmount,"onUpdate:modelValue":e[23]||(e[23]=a=>r.value.form.minAmount=a),min:0,precision:2},null,8,["modelValue"])]),_:1}),l(n,{label:"有效期开始"},{default:t(()=>[l(A,{modelValue:r.value.form.validFrom,"onUpdate:modelValue":e[24]||(e[24]=a=>r.value.form.validFrom=a),type:"datetime",placeholder:"选择日期时间"},null,8,["modelValue"])]),_:1}),l(n,{label:"有效期结束"},{default:t(()=>[l(A,{modelValue:r.value.form.validTo,"onUpdate:modelValue":e[25]||(e[25]=a=>r.value.form.validTo=a),type:"datetime",placeholder:"选择日期时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(S,{modelValue:f.value.visible,"onUpdate:modelValue":e[30]||(e[30]=a=>f.value.visible=a),title:"发放优惠券",width:"500px"},{footer:t(()=>[l(i,{onClick:e[29]||(e[29]=a=>f.value.visible=!1)},{default:t(()=>[...e[49]||(e[49]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:K},{default:t(()=>[...e[50]||(e[50]=[d("确定发放",-1)])]),_:1})]),default:t(()=>[l(Y,{title:`将发放优惠券: ${f.value.couponName}`,type:"info",closable:!1,style:{"margin-bottom":"20px"}},null,8,["title"]),l(D,{model:f.value.form,"label-width":"100px"},{default:t(()=>[l(n,{label:"用户ID列表"},{default:t(()=>[l(v,{modelValue:f.value.userIdsInput,"onUpdate:modelValue":e[28]||(e[28]=a=>f.value.userIdsInput=a),type:"textarea",rows:5,placeholder:"请输入用户ID，多个用户用逗号或换行分隔，例如：1,2,3 或每行一个ID"},null,8,["modelValue"])]),_:1}),l(n,null,{default:t(()=>[l(Z,{type:"info",size:"small"},{default:t(()=>[...e[48]||(e[48]=[d(" 支持批量发放，将自动过滤无效的ID ",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},we=ue(ve,[["__scopeId","data-v-cd85c5cd"]]);export{we as default};
