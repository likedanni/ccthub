批次 4 (P1/P2 剩余)\*\*：包含剩余 11 张表，完成所有功能。

// ============================================
// 长治文旅平台 - 数据库设计 v1.0
// 批次 4: P1/P2 剩余支撑表 (11 张表)
// 这是最后一批，完成后即获得全部 30 张表
// ============================================

// 20. 订单退款表 (售后核心)
Table order_refunds {
id bigint [pk, increment]
refund_no varchar(32) [not null, unique, note: '退款单号，如 REFUND202412110001']
order_no varchar(32) [ref: > orders.order_no, not null]
user_id bigint [ref: > users.id, not null]
refund_type tinyint [not null, note: '退款类型: 1-全额退款, 2-部分退款']
refund_amount decimal(10, 2) [not null]
refund_reason varchar(200) [not null]
refund_evidence json [note: 'JSON，退款凭证图片等']
status tinyint [default: 0, note: '状态: 0-待审核, 1-审核通过, 2-审核拒绝, 3-退款中, 4-成功, 5-失败']
auditor_id bigint [note: '审核人 ID']
audited_at datetime [note: '审核时间']
audit_note varchar(500) [note: '审核备注']
payment_refund_no varchar(64) [note: '支付渠道退款流水号']
payment_refund_at datetime [note: '支付渠道退款时间']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
order_no
user_id
refund_no
status
created_at
}
note: '订单退款申请与处理表。与 order_changes 共同构成售后体系。'
}

// 21. 订单改签表 (票务售后)
Table order_changes {
id bigint [pk, increment]
change_no varchar(32) [not null, unique, note: '改签单号']
order_no varchar(32) [ref: > orders.order_no, not null]
user_id bigint [ref: > users.id, not null]
change_type tinyint [not null, note: '类型: 1-改日期, 2-改时间, 3-改票种']
original_ticket_id bigint [note: '原票种 ID']
new_ticket_id bigint [note: '新票种 ID']
original_use_date date
new_use_date date
price_difference decimal(10, 2) [note: '差价，正为需补，负为应退']
change_fee decimal(10, 2) [default: 0.00]
total_amount decimal(10, 2) [not null, note: '改签总金额']
change_reason varchar(200) [not null]
status tinyint [default: 0, note: '状态: 0-待审核, 1-审核通过, 2-拒绝, 3-已完成']
auditor_id bigint
audited_at datetime
audit_note varchar(500)
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
order_no
user_id
change_no
status
}
note: '门票订单改签记录表。涉及库存释放和重新锁定。'
}

// 22. 用户反馈表 (客服与体验)
Table user_feedback {
id bigint [pk, increment]
user_id bigint [ref: > users.id, not null]
type tinyint [not null, note: '反馈类型: 1-投诉, 2-建议, 3-咨询']
content text [not null]
images json [note: 'JSON，上传的凭证图片']
contact_phone varchar(20)
order_no varchar(32) [note: '关联订单']
merchant_id bigint [note: '关联商户']
status tinyint [default: 0, note: '处理状态: 0-待处理, 1-处理中, 2-已处理']
handler_id bigint [note: '处理人 ID']
handled_at datetime [note: '处理时间']
handle_result text [note: '处理结果']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
user_id
type
status
created_at
order_no
}
note: '用户反馈与工单表。用于客服跟踪和处理。'
}

// 23. 用户评价表 (UGC 与信用)
Table user_comments {
id bigint [pk, increment]
user_id bigint [ref: > users.id, not null]
target_type tinyint [not null, note: '评价对象类型: 1-景区/商户, 2-商品, 3-活动']
target_id bigint [not null, note: '评价对象 ID']
order_no varchar(32) [ref: > orders.order_no, not null, note: '必须基于订单评价']
rating tinyint [not null, note: '评分: 1-5 星']
content text
images json [note: '评价图片']
is_anonymous boolean [default: false]
like_count int [default: 0]
reply_count int [default: 0]
status tinyint [default: 1, note: '状态: 1-显示, 0-隐藏']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
user_id
target_type
target_id
order_no
rating
created_at
}
note: '用户评价表。支持对商户、商品、活动的多维度评价，是信用体系基础。'
}

// 24. 活动参与记录表 (活动运营关联)
Table activity_participations {
id bigint [pk, increment]
activity_id bigint [ref: > activities.id, not null]
user_id bigint [ref: > users.id, not null]
participation_status tinyint [default: 1, note: '参与状态: 1-进行中, 2-已完成, 3-已放弃']
reward_status tinyint [default: 0, note: '奖励状态: 0-未发放, 1-已发放, 2-发放失败']
reward_detail json [note: '实际获得的奖励详情']
checkpoints_progress json [note: 'JSON，打卡点完成进度']
joined_at datetime [default: `now()`]
completed_at datetime
updated_at datetime [default: `now()`]

indexes {
(activity_id, user_id) [unique, note: '同一用户同一活动只能参与一次']
user_id
participation_status
joined_at
}
note: '用户参与营销活动的记录表。用于跟踪进度和发放奖励。'
}

// 25. 秒杀活动表 (高并发营销)
Table seckill_events {
id bigint [pk, increment]
product_id bigint [ref: > products.id, not null]
title varchar(200) [not null]
seckill_price decimal(10, 2) [not null]
original_price decimal(10, 2) [not null]
total_inventory int [not null, note: '秒杀总库存']
available_inventory int [not null, note: '秒杀可用库存']
limit_per_user int [default: 1, note: '每人限购']
starts_at datetime [not null]
ends_at datetime [not null]
status tinyint [default: 0, note: '状态: 0-未开始, 1-进行中, 2-已结束, 3-手动关闭']
created_at datetime [default: `now()`]

indexes {
product_id
(starts_at, ends_at)
status
}
note: '秒杀/闪购活动专用表，独立库存以应对高并发。需配合缓存和队列。'
}

// 26. 商户钱包表 (B 端资金账户)
Table merchant_wallet {
id bigint [pk, increment]
merchant_id bigint [ref: > merchants.id, not null, unique]
balance decimal(12, 2) [default: 0.00, note: '可提现余额']
frozen_balance decimal(12, 2) [default: 0.00, note: '冻结余额(结算中/提现中)']
total_income decimal(12, 2) [default: 0.00, note: '累计收入']
total_withdrawn decimal(12, 2) [default: 0.00, note: '累计已提现']
security_level tinyint [default: 1]
withdraw_password_hash varchar(128)
status tinyint [default: 1, note: '状态: 1-正常, 0-冻结']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
merchant_id
status
}
note: '商户钱包，用于存放可提现的结算收入。'
}

// 27. 发票记录表 (财务)
Table invoices {
id bigint [pk, increment]
invoice_no varchar(32) [not null, unique, note: '发票号码']
user_id bigint [ref: > users.id, not null]
type tinyint [not null, note: '发票类型: 1-普通, 2-专用']
title varchar(200) [not null, note: '发票抬头']
tax_number varchar(50) [note: '纳税人识别号']
amount decimal(10, 2) [not null]
status tinyint [default: 0, note: '开票状态: 0-待开, 1-开票中, 2-成功, 3-失败']
file_url varchar(500) [note: '发票文件 URL']
order_no varchar(32) [note: '关联订单(可为空，支持合并开票)']
applied_at datetime [default: `now()`]
issued_at datetime [note: '开票时间']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
user_id
invoice_no
status
applied_at
}
note: '用户发票申请与记录表。可与订单 1 对 1 或 1 对多。'
}

// 28. 资讯文章表 (内容运营)
Table articles {
id bigint [pk, increment]
category varchar(50) [not null, note: '文章分类']
title varchar(200) [not null]
author varchar(50)
cover_image varchar(500)
summary varchar(500) [note: '摘要']
content text [not null]
view_count int [default: 0]
like_count int [default: 0]
is_pinned boolean [default: false, note: '是否置顶']
status tinyint [default: 0, note: '状态: 0-草稿, 1-已发布, 2-隐藏']
published_at datetime [note: '发布时间']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
category
status
published_at
is_pinned
}
note: '平台资讯、攻略、公告等文章内容表。'
}

// 29. 操作日志表 (安全审计)
Table operation_logs {
id bigint [pk, increment]
user_id bigint [note: '操作人 ID，可为空(系统操作)']
user_type tinyint [note: '用户类型: 1-平台用户, 2-商户, 3-管理员']
module varchar(50) [not null, note: '操作模块']
action varchar(200) [not null, note: '操作内容']
request_method varchar(10)
request_url varchar(500)
request_params text
ip_address varchar(50)
user_agent text
is_success boolean [default: true]
error_message text
duration_ms int [note: '操作耗时(毫秒)']
created_at datetime [default: `now()`]

indexes {
user_id
module
created_at
is_success
}
note: '系统关键操作审计日志表，用于安全追踪和行为分析。'
}

// 30. 数据字典表 (系统维护)
Table data_dictionaries {
id bigint [pk, increment]
dict_type varchar(50) [not null, note: '字典类型，如: user_status']
dict_code varchar(50) [not null, note: '字典编码，如: 0']
dict_value varchar(200) [not null, note: '字典值，如: 正常']
sort_order int [default: 0]
is_default boolean [default: false, note: '是否默认值']
status tinyint [default: 1, note: '状态: 1-启用, 0-停用']
remark varchar(200)
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
(dict_type, dict_code) [unique, note: '类型下编码唯一']
dict_type
sort_order
status
}
note: '系统数据字典表，统一管理所有状态、类型的枚举值，便于维护和多语言扩展。'
}

// ============================================
// 批次 4 - 新增关系说明 (至此，30 张表关系网完成)
// 1. orders (1) : (N) order_refunds
// 2. orders (1) : (N) order_changes
// 3. users (1) : (N) user_feedback
// 4. users (1) : (N) user_comments
// 5. activities (1) : (N) activity_participations
// 6. products (1) : (N) seckill_events
// 7. merchants (1) : (1) merchant_wallet
// 8. users (1) : (N) invoices
// 9. 至此，所有 30 张表的关系网已完全建立。
// ============================================
