批次 3 (P1 核心)\*\*：包含第 4、5、9、10、22、23、24 号表（共 7 张），构建积分、营销、财务能力。

// ============================================
// 长治文旅平台 - 数据库设计 v1.0
// 批次 3: P1 核心扩展表 (7 张表)
// 注意：表名与之前批次保持一致，可直接合并
// ============================================

// 13. 用户积分流水表 (会员与营销体系核心)
Table user_points {
id bigint [pk, increment]
user_id bigint [ref: > users.id, not null]
change_type tinyint [not null, note: '变动类型: 1-增加, 2-减少']
source varchar(50) [not null, note: '积分来源/用途: order_pay, daily_checkin, invite, exchange']
points int [not null, note: '变动积分数额，正负代表增减']
current_balance int [not null, note: '变动后实时余额']
order_no varchar(32) [note: '关联订单号']
activity_id bigint [note: '关联活动 ID']
expires_at datetime [note: '积分过期时间']
status tinyint [default: 1, note: '状态: 1-有效, 0-无效(如撤销)']
created_at datetime [default: `now()`]
remark varchar(200) [note: '备注']

indexes {
user_id
source
created_at
expires_at
order_no
}
note: '用户积分流水表，所有积分变动有迹可循。需定期清理过期积分记录。'
}

// 14. 用户钱包表 (资金账户)
Table user_wallet {
id bigint [pk, increment]
user_id bigint [ref: > users.id, not null, unique]
balance decimal(10, 2) [default: 0.00, note: '可用余额']
frozen_balance decimal(10, 2) [default: 0.00, note: '冻结金额(如提现中)']
total_deposit decimal(10, 2) [default: 0.00, note: '累计充值']
total_consumption decimal(10, 2) [default: 0.00, note: '累计消费']
security_level tinyint [default: 1]
pay_password_hash varchar(128) [note: '支付密码哈希']
status tinyint [default: 1, note: '状态: 1-正常, 0-冻结']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
user_id
status
}
note: '用户钱包（余额）账户，独立于积分体系，用于储值消费。'
}

// 15. 优惠券模板表 (营销基础)
Table coupons {
id bigint [pk, increment]
name varchar(100) [not null]
type tinyint [not null, note: '券类型: 1-满减券, 2-折扣券, 3-代金券']
value decimal(10, 2) [not null, note: '优惠值: 满减金额、折扣(0.9)或固定金额']
min_spend decimal(10, 2) [note: '最低消费金额门槛']
applicable_type tinyint [not null, note: '适用范围: 1-全平台, 2-指定商户, 3-指定商品']
applicable_ids json [note: 'JSON 数组，适用的商户或商品 ID 列表']
validity_type tinyint [not null, note: '有效期类型: 1-固定时段, 2-领取后生效']
valid_days int [note: '领取后有效天数（当 validity_type=2 时）']
starts_at datetime [note: '有效期开始时间']
expires_at datetime [note: '有效期结束时间']
total_quantity int [note: '发放总张数，null 表示不限量']
remaining_quantity int [note: '剩余可发放张数']
limit_per_user int [default: 1, note: '每人限领张数']
status tinyint [default: 0, note: '状态: 0-未开始, 1-发放中, 2-已结束, 3-停用']
created_at datetime [default: `now()`]

indexes {
status
applicable_type
expires_at
}
note: '优惠券定义模板。用户领取后生成 user_coupons 记录。'
}

// 16. 用户优惠券表 (营销关联)
Table user_coupons {
id bigint [pk, increment]
user_id bigint [ref: > users.id, not null]
coupon_id bigint [ref: > coupons.id, not null]
coupon_code varchar(50) [not null, unique, note: '唯一券码']
status tinyint [default: 0, note: '状态: 0-未使用, 1-已使用, 2-已过期']
received_at datetime [default: `now()`]
used_at datetime
order_no varchar(32) [note: '使用的订单号']
expires_at datetime [not null, note: '该张券的实际过期时间']

indexes {
user_id
coupon_id
status
expires_at
coupon_code
}
note: '用户实际领取和持有的优惠券。由 coupons 模板生成。'
}

// 17. 商户结算主表 (财务核心)
Table merchant_settlements {
id bigint [pk, increment]
settlement_no varchar(32) [not null, unique, note: '结算单号，如 SETTLE202412001']
merchant_id bigint [ref: > merchants.id, not null]
period varchar(20) [not null, note: '结算周期，如 2024-12']
total_amount decimal(12, 2) [not null, note: '周期内交易总金额']
platform_fee decimal(12, 2) [not null, note: '平台服务费']
settlement_amount decimal(12, 2) [not null, note: '应付给商户的金额']
settlement_status tinyint [default: 0, note: '结算状态: 0-待结算, 1-结算中, 2-结算成功, 3-结算失败']
payment_status tinyint [default: 0, note: '付款状态: 0-待付款, 1-付款中, 2-付款成功, 3-付款失败']
payment_method varchar(50) [note: '付款方式']
payment_time datetime
invoice_status tinyint [default: 0, note: '发票状态: 0-未开, 1-已申请, 2-已开票']
note text [note: '备注']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
merchant_id
settlement_no
period
settlement_status
created_at
}
note: '按周期给商户的结算单主表。明细见 settlement_details (下张表)。'
}

// 18. 结算明细表 (财务核心)
Table settlement_details {
id bigint [pk, increment]
settlement_id bigint [ref: > merchant_settlements.id, not null]
order_no varchar(32) [not null]
order_type tinyint [not null]
order_amount decimal(10, 2) [not null]
platform_fee_rate decimal(5, 4) [not null]
platform_fee decimal(10, 2) [not null]
merchant_share decimal(10, 2) [not null]
settled_at datetime [note: '计入结算时间']
status tinyint [default: 1, note: '状态: 1-正常, 0-异常(如退款需冲正)']

indexes {
settlement_id
order_no
}
note: '结算单明细，记录每一笔订单的分账构成。退款订单会产生冲正明细。'
}

// 19. 营销活动表 (活动运营)
Table activities {
id bigint [pk, increment]
merchant_id bigint [ref: > merchants.id, note: '为空则表示平台活动']
name varchar(200) [not null]
type tinyint [not null, note: '活动类型: 1-打卡任务, 2-积分奖励, 3-主题促销']
cover_image varchar(500)
description text
starts_at datetime [not null]
ends_at datetime [not null]
location varchar(500)
participation_limit int
requirement_type tinyint [default: 0, note: '参与条件: 0-无, 1-需购票, 2-需积分, 3-需报名']
requirement_value varchar(200)
reward_config json [not null, note: '奖励配置 JSON']
audit_status tinyint [default: 0, note: '审核状态: 0-待审, 1-通过, 2-拒绝']
status tinyint [default: 0, note: '活动状态: 0-未开始, 1-进行中, 2-已结束, 3-取消']
created_at datetime [default: `now()`]
updated_at datetime [default: `now()`]

indexes {
merchant_id
type
(starts_at, ends_at)
status
audit_status
}
note: '营销活动主表，支持平台和商户活动。参与记录见 activity_participations (下批)。'
}

// ============================================
// 批次 3 - 新增关系说明
// 1. users (1) : (N) user_points
// 2. users (1) : (1) user_wallet
// 3. coupons (1) : (N) user_coupons
// 4. merchants (1) : (N) merchant_settlements
// 5. merchant_settlements (1) : (N) settlement_details
// 6. merchants (1) : (N) activities
// 7. orders (1) : (1) settlement_details (通过 order_no 关联)
// ============================================
